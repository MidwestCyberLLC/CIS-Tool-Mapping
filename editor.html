<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIS Mapper Data Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-input, .form-select, .form-textarea {
            border: 1px solid #D1D5DB; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.2s;
            background-color: white;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #3B82F6; /* blue-500 */
            box-shadow: 0 0 0 2px #BFDBFE; /* blue-200 */
        }
        .form-input[disabled] {
            background-color: #F3F4F6; /* gray-100 */
            color: #6B7280; /* gray-500 */
            cursor: not-allowed;
        }
        .form-select[multiple] {
            padding: 0.5rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-primary { background-color: #2563EB; /* blue-600 */ color: white; }
        .btn-primary:hover { background-color: #1D4ED8; /* blue-700 */ }
        .btn-secondary { background-color: #4B5563; /* gray-600 */ color: white; }
        .btn-secondary:hover { background-color: #374151; /* gray-700 */ }
        .btn-green { background-color: #059669; /* green-600 */ color: white; }
        .btn-green:hover { background-color: #047857; /* green-700 */ }
        .btn-red { background-color: #DC2626; /* red-600 */ color: white; }
        .btn-red:hover { background-color: #B91C1C; /* red-700 */ }
        .disabled-btn { background-color: #D1D5DB; /* gray-300 */ cursor: not-allowed; }
        
        /* Custom class for the safeguard list in modify mode */
        .safeguard-checkbox-list {
            max-height: 500px; /* Increased height to accommodate rationales */
            overflow-y: auto;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: #F9FAFB; /* gray-50 */
        }
        .safeguard-checkbox-item {
            display: flex;
            flex-direction: column; /* Changed to column to stack checkbox row and rationale input */
            padding: 0.5rem 0;
            border-bottom: 1px solid #E5E7EB; /* Add separator */
        }
        .safeguard-checkbox-row {
             display: flex;
             align-items: center;
        }
        .safeguard-checkbox-row input {
            margin-right: 0.75rem;
            height: 1rem;
            width: 1rem;
        }
        .safeguard-checkbox-row label {
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* gray-700 */
            cursor: pointer;
        }
        .safeguard-rationale-input {
            margin-top: 0.5rem;
            margin-left: 1.75rem; /* Indent to align with label text */
            font-size: 0.875rem;
            width: 90%;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="container mx-auto max-w-4xl bg-white p-6 shadow-xl rounded-lg">
        <h1 class="text-3xl font-bold text-blue-800 mb-6">CIS Mapper Data Editor</h1>

        <!-- Section 1: Load Data -->
        <div class="mb-6 p-4 border rounded-lg bg-gray-50">
            <h2 class="text-xl font-semibold mb-3">1. Load Data from GitHub</h2>
            <p class="text-sm text-gray-600 mb-4">Paste the "raw" GitHub URLs for your JSON files.</p>
            <div class="space-y-3">
                <div>
                    <label for="toolsUrl" class="block text-sm font-medium text-gray-700">Tools URL (tools.json)</label>
                    <input type="text" id="toolsUrl" class="form-input" value="https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/refs/heads/main/tools.json">
                </div>
                <div>
                    <label for="safeguardsUrl" class="block text-sm font-medium text-gray-700">Safeguards URL (safeguards.json)</label>
                    <input type="text" id="safeguardsUrl" class="form-input" value="https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/refs/heads/main/safeguards.json">
                </div>
                <div>
                    <label for="mappingUrl" class="block text-sm font-medium text-gray-700">Mapping URL (mapping.json)</label>
                    <input type="text" id="mappingUrl" class="form-input" value="https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/refs/heads/main/mapping.json">
                </div>
            </div>
            <button id="loadDataBtn" class="btn btn-primary mt-4">Load Data</button>
            <p id="loadStatus" class="mt-2 text-sm font-medium"></p>
        </div>

        <!-- Section 1.5: Mode Selection -->
        <div id="modeSelectionSection" class="hidden mb-6 p-4 border rounded-lg">
            <h2 class="text-xl font-semibold mb-3">2. Choose Your Mode</h2>
            <p class="text-sm text-gray-600 mb-4">Data loaded. Do you want to add new data or modify existing data?</p>
            <div class="flex space-x-4">
                <button id="showAddModeBtn" class="btn btn-secondary">Add New Data</button>
                <button id="showModifyModeBtn" class="btn btn-secondary">Modify Existing Data</button>
            </div>
        </div>

        <!-- Add Mode Container -->
        <div id="addModeContainer" class="hidden">
            <!-- Section 2: Add New Tool -->
            <fieldset class="mb-6 p-4 border rounded-lg">
                <legend class="text-xl font-semibold mb-3 px-2">Add a New Tool</legend>
                <form id="toolForm" class="space-y-3">
                    <div>
                        <label for="toolId" class="block text-sm font-medium text-gray-700">Tool ID (e.g., T6)</label>
                        <input type="text" id="toolId" class="form-input" required>
                    </div>
                    <div>
                        <label for="toolName" class="block text-sm font-medium text-gray-700">Tool Name</label>
                        <input type="text" id="toolName" class="form-input" required>
                    </div>
                    <div>
                        <label for="toolDesc" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="toolDesc" rows="2" class="form-textarea" required></textarea>
                    </div>
                    <div>
                        <label for="toolUrl" class="block text-sm font-medium text-gray-700">URL</label>
                        <input type="url" id="toolUrl" class="form-input" placeholder="https://..." required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="toolEducationUse" class="block text-sm font-medium text-gray-700">Education Use</label>
                            <select id="toolEducationUse" class="form-select">
                                <option value="false">False</option>
                                <option value="true">True</option>
                            </select>
                        </div>
                        <div>
                            <label for="toolCost" class="block text-sm font-medium text-gray-700">Cost</label>
                            <select id="toolCost" class="form-select">
                                <option>$</option>
                                <option>$$</option>
                                <option>$$$</option>
                                <option>$$$$</option>
                                <option>$$$$$</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-secondary">Add Tool</button>
                    <p id="toolStatus" class="mt-2 text-sm font-medium text-green-600"></p>
                </form>
            </fieldset>

            <!-- Section 3: Add New Mapping -->
            <fieldset class="mb-6 p-4 border rounded-lg">
                <legend class="text-xl font-semibold mb-3 px-2">Add a New Mapping</legend>
                <form id="mappingForm" class="space-y-3">
                    <div>
                        <label for="toolSelect" class="block text-sm font-medium text-gray-700">Select Tool</label>
                        <select id="toolSelect" class="form-select" required>
                            <option value="" disabled selected>-- Select a Tool --</option>
                        </select>
                    </div>
                    <!-- UPDATED MAPPING SECTION FOR ADD MODE -->
                    <div>
                         <label class="block text-sm font-medium text-gray-700 mb-2">Select Safeguard(s) & Rationale</label>
                         <p class="text-sm text-gray-600 mb-2">Select safeguards that map to this tool and provide a rationale for each.</p>
                         <div id="addSafeguardsList" class="safeguard-checkbox-list" style="max-height: 300px;">
                             <!-- Checkboxes populated by JS -->
                         </div>
                    </div>
                    <button type="submit" class="btn btn-secondary">Add Mapping(s)</button>
                    <p id="mappingStatus" class="mt-2 text-sm font-medium text-green-600"></p>
                </form>
            </fieldset>
        </div>

        <!-- Modify Mode Container -->
        <div id="modifyModeContainer" class="hidden">
            <fieldset class="mb-6 p-4 border rounded-lg">
                <legend class="text-xl font-semibold mb-3 px-2">Modify Existing Tool & Mappings</legend>
                <div class="space-y-3">
                    <div>
                        <label for="modifyToolSelect" class="block text-sm font-medium text-gray-700">Select Tool to Modify</label>
                        <select id="modifyToolSelect" class="form-select">
                            <option value="" disabled selected>-- Select a Tool --</option>
                        </select>
                    </div>

                    <!-- This form appears when a tool is selected -->
                    <div id="modifyFormContainer" class="hidden space-y-4 pt-4 border-t">
                        <!-- Tool Attributes -->
                        <h3 class="text-lg font-medium text-gray-900">Tool Attributes</h3>
                        <div>
                            <label for="modifyToolId" class="block text-sm font-medium text-gray-700">Tool ID</label>
                            <input type="text" id="modifyToolId" class="form-input" disabled>
                        </div>
                        <div>
                            <label for="modifyToolName" class="block text-sm font-medium text-gray-700">Tool Name</label>
                            <input type="text" id="modifyToolName" class="form-input" required>
                        </div>
                        <div>
                            <label for="modifyToolDesc" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="modifyToolDesc" rows="3" class="form-textarea" required></textarea>
                        </div>
                        <div>
                            <label for="modifyToolUrl" class="block text-sm font-medium text-gray-700">URL</label>
                            <input type="url" id="modifyToolUrl" class="form-input" placeholder="https://..." required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="modifyToolEducationUse" class="block text-sm font-medium text-gray-700">Education Use</label>
                                <select id="modifyToolEducationUse" class="form-select">
                                    <option value="false">False</option>
                                    <option value="true">True</option>
                                </select>
                            </div>
                            <div>
                                <label for="modifyToolCost" class="block text-sm font-medium text-gray-700">Cost</label>
                                <select id="modifyToolCost" class="form-select">
                                    <option>$</option>
                                    <option>$$</option>
                                    <option>$$$</option>
                                    <option>$$$$</option>
                                    <option>$$$$$</option>
                                </select>
                            </div>
                        </div>

                        <!-- Mappings -->
                        <h3 class="text-lg font-medium text-gray-900 pt-2">Safeguard Mappings</h3>
                        <p class="text-sm text-gray-600">Select safeguards that map to this tool and provide a rationale for each.</p>
                        <div id="modifySafeguardsList" class="safeguard-checkbox-list">
                            <!-- Checkboxes and Rationale inputs will be populated by JS -->
                        </div>
                        
                        <!-- Actions -->
                        <div class="pt-4 flex flex-wrap gap-4">
                            <button id="saveChangesBtn" class="btn btn-primary">Save Changes</button>
                            <div class="flex-grow"></div> <!-- Spacer -->
                            <button id="removeToolBtn" class="btn btn-red">Remove This Tool (Single Click)</button>
                        </div>
                        <p id="modifyStatus" class="mt-2 text-sm font-medium"></p>
                    </div>
                </div>
            </fieldset>
        </div>


        <!-- Section 4: Generate Files -->
        <fieldset id="generateSection" class="hidden p-4 border rounded-lg bg-gray-50">
            <h2 class="text-xl font-semibold mb-3">Final Step: Generate & Download Files</h2>
            <p class="text-sm text-gray-600 mb-4">When you're finished adding or modifying data, download the new JSON files. You must then upload these to GitHub, replacing the old ones.</p>
            <div class="flex space-x-4">
                <button id="downloadToolsBtn" class="btn btn-green">Download tools.json</button>
                <button id="downloadMappingBtn" class="btn btn-green">Download mapping.json</button>
            </div>
            <p class="text-xs text-gray-500 mt-4">Note: If you only added mappings, you still may want to download `tools.json` if you added tools in this session.</p>
        </fieldset>
    </div>

    <script>
        // In-memory data stores
        let tools = [];
        let safeguards = [];
        let mapping = [];
        let currentModifyToolId = null; 
        let sortedSafeguards = []; 

        // DOM Elements
        const loadDataBtn = document.getElementById('loadDataBtn');
        const loadStatus = document.getElementById('loadStatus');
        
        // Mode selection
        const modeSelectionSection = document.getElementById('modeSelectionSection');
        const showAddModeBtn = document.getElementById('showAddModeBtn');
        const showModifyModeBtn = document.getElementById('showModifyModeBtn');

        // Mode containers
        const addModeContainer = document.getElementById('addModeContainer');
        const modifyModeContainer = document.getElementById('modifyModeContainer');
        
        // Add Mode Elements
        const toolForm = document.getElementById('toolForm');
        const toolStatus = document.getElementById('toolStatus');
        const toolIdInput = document.getElementById('toolId'); 
        const mappingForm = document.getElementById('mappingForm');
        const mappingStatus = document.getElementById('mappingStatus');
        const toolSelect = document.getElementById('toolSelect');
        // New Add Mode List Element
        const addSafeguardsList = document.getElementById('addSafeguardsList');

        // Modify Mode Elements
        const modifyToolSelect = document.getElementById('modifyToolSelect');
        const modifyFormContainer = document.getElementById('modifyFormContainer');
        const modifyToolId = document.getElementById('modifyToolId');
        const modifyToolName = document.getElementById('modifyToolName');
        const modifyToolDesc = document.getElementById('modifyToolDesc');
        const modifyToolUrl = document.getElementById('modifyToolUrl');
        const modifyToolEducationUse = document.getElementById('modifyToolEducationUse'); 
        const modifyToolCost = document.getElementById('modifyToolCost'); 
        const modifySafeguardsList = document.getElementById('modifySafeguardsList');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const removeToolBtn = document.getElementById('removeToolBtn');
        const modifyStatus = document.getElementById('modifyStatus');

        // Generate Section
        const generateSection = document.getElementById('generateSection');
        const downloadToolsBtn = document.getElementById('downloadToolsBtn');
        const downloadMappingBtn = document.getElementById('downloadMappingBtn');

        // --- 1. Load Data ---
        loadDataBtn.addEventListener('click', async () => {
            const toolsUrl = document.getElementById('toolsUrl').value;
            const safeguardsUrl = document.getElementById('safeguardsUrl').value;
            const mappingUrl = document.getElementById('mappingUrl').value;

            if (!toolsUrl || !safeguardsUrl || !mappingUrl) {
                setLoadStatus('Please provide all 3 URLs.', 'red');
                return;
            }

            setLoadStatus('Loading...', 'blue');

            try {
                const [toolsRes, safeguardsRes, mappingRes] = await Promise.all([
                    fetch(toolsUrl),
                    fetch(safeguardsUrl),
                    fetch(mappingUrl)
                ]);

                if (!toolsRes.ok || !safeguardsRes.ok || !mappingRes.ok) {
                    throw new Error('One or more files not found. Check URLs and CORS permissions.');
                }

                tools = await toolsRes.json();
                safeguards = await safeguardsRes.json();
                mapping = await mappingRes.json();

                sortedSafeguards = [...safeguards].sort((a, b) => a.ControlNumber - b.ControlNumber || a.SafeguardNumber - b.SafeguardNumber);

                setLoadStatus(`Successfully loaded ${tools.length} tools, ${safeguards.length} safeguards, and ${mapping.length} mappings.`, 'green');

                populateAddModeDropdowns();
                populateModifyToolDropdown();
                suggestNextToolId();

                modeSelectionSection.classList.remove('hidden');
                addModeContainer.classList.add('hidden');
                modifyModeContainer.classList.add('hidden');
                generateSection.classList.add('hidden');
                modifyFormContainer.classList.add('hidden');

            } catch (error) {
                console.error('Failed to load data:', error);
                setLoadStatus(`Error: ${error.message}`, 'red');
            }
        });

        // --- 1.5. Mode Selection Listeners ---
        showAddModeBtn.addEventListener('click', () => {
            modeSelectionSection.classList.add('hidden');
            addModeContainer.classList.remove('hidden');
            generateSection.classList.remove('hidden');
            modifyModeContainer.classList.add('hidden');
        });

        showModifyModeBtn.addEventListener('click', () => {
            modeSelectionSection.classList.add('hidden');
            addModeContainer.classList.add('hidden');
            generateSection.classList.remove('hidden');
            modifyModeContainer.classList.remove('hidden');
        });

        // --- Helper: Set Status ---
        function setLoadStatus(message, color) {
            loadStatus.textContent = message;
            loadStatus.className = `mt-2 text-sm font-medium text-${color}-600`;
        }
        function setModifyStatus(message, color) {
            modifyStatus.textContent = message;
            modifyStatus.className = `mt-2 text-sm font-medium text-${color}-600`;
            // Clear message after 5 seconds for errors, 3 for success
            setTimeout(() => { modifyStatus.textContent = ''; }, color === 'red' ? 5000 : 3000);
        }

        // --- SHARED: Render Safeguard List with Rationales ---
        // Used by both Add and Modify modes to ensure consistent UI and behavior
        function renderSafeguardsList(containerElement, modePrefix, toolIdForEditing = null) {
            containerElement.innerHTML = '';
            sortedSafeguards.forEach(sg => {
                // If editing, check if mapping exists
                let isChecked = false;
                let currentRationale = '';
                if (toolIdForEditing) {
                     const existingMapping = mapping.find(m => m.ToolID === toolIdForEditing && m.SafeguardID === sg.ID);
                     if (existingMapping) {
                         isChecked = true;
                         currentRationale = existingMapping.Rationale || '';
                     }
                }

                // Create elements
                const itemDiv = document.createElement('div');
                itemDiv.className = 'safeguard-checkbox-item';
                
                const rowDiv = document.createElement('div');
                rowDiv.className = 'safeguard-checkbox-row';

                const uniqueId = `${modePrefix}-sg-${sg.ID}`;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = uniqueId;
                checkbox.value = sg.ID;
                checkbox.checked = isChecked;

                const label = document.createElement('label');
                label.htmlFor = uniqueId;
                label.textContent = `SG ${sg.ControlNumber}.${sg.SafeguardNumber}: ${sg.Title}`;

                rowDiv.appendChild(checkbox);
                rowDiv.appendChild(label);

                const rationaleInput = document.createElement('input');
                rationaleInput.type = 'text';
                rationaleInput.className = 'form-input safeguard-rationale-input';
                rationaleInput.placeholder = 'Rationale (required if checked)';
                rationaleInput.value = currentRationale;
                rationaleInput.style.display = isChecked ? 'block' : 'none';

                // Toggle visibility on check
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        rationaleInput.style.display = 'block';
                        rationaleInput.focus();
                    } else {
                        rationaleInput.style.display = 'none';
                        rationaleInput.classList.remove('border-red-500', 'bg-red-50'); // Clear error state on uncheck
                    }
                });

                itemDiv.appendChild(rowDiv);
                itemDiv.appendChild(rationaleInput);
                containerElement.appendChild(itemDiv);
            });
        }


        // --- Populate Dropdowns ---
        function populateAddModeDropdowns() {
            toolSelect.innerHTML = '<option value="" disabled selected>-- Select a Tool --</option>';
            
            tools.sort((a, b) => a.Name.localeCompare(b.Name)).forEach(tool => {
                const option = new Option(`${tool.ID}: ${tool.Name}`, tool.ID);
                toolSelect.add(option);
            });

            // Use shared renderer for the add mode list
            renderSafeguardsList(addSafeguardsList, 'add');
        }

        function populateModifyToolDropdown() {
            modifyToolSelect.innerHTML = '<option value="" disabled selected>-- Select a Tool to Modify --</option>';
            tools.sort((a, b) => a.Name.localeCompare(b.Name)).forEach(tool => {
                const option = new Option(`${tool.ID}: ${tool.Name}`, tool.ID);
                modifyToolSelect.add(option);
            });
        }

        function suggestNextToolId() {
            const existingIds = new Set(
                tools.map(tool => parseInt(tool.ID.replace('T', '')))
                     .filter(id => !isNaN(id))
            );
            let nextIdNum = 1;
            while (existingIds.has(nextIdNum)) {
                nextIdNum++;
            }
            toolIdInput.value = `T${nextIdNum}`;
        }

        // --- 2. Add Tool ---
        toolForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = toolIdInput.value;
            const name = document.getElementById('toolName').value;
            const desc = document.getElementById('toolDesc').value;
            const url = document.getElementById('toolUrl').value;
            const educationUse = document.getElementById('toolEducationUse').value === 'true'; 
            const cost = document.getElementById('toolCost').value; 

            if (tools.some(t => t.ID === id)) {
                toolStatus.textContent = `Error: Tool ID "${id}" already exists.`;
                toolStatus.className = 'mt-2 text-sm font-medium text-red-600';
                return;
            }

            const newTool = { 
                ID: id, 
                Name: name, 
                Description: desc, 
                URL: url,
                EducationUse: educationUse,
                Cost: cost
            };

            tools.push(newTool);
            toolStatus.textContent = `Added "${name}". You now have ${tools.length} tools.`;
            toolStatus.className = 'mt-2 text-sm font-medium text-green-600';
            
            populateAddModeDropdowns();
            populateModifyToolDropdown();
            toolForm.reset();
            document.getElementById('toolEducationUse').value = 'false'; 
            document.getElementById('toolCost').value = '$';
            suggestNextToolId();
        });

        // --- 3. Add Mapping (UPDATED for individual rationales) ---
        mappingForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const toolID = toolSelect.value;

            if (!toolID) {
                mappingStatus.textContent = 'Please select a tool.';
                mappingStatus.className = 'mt-2 text-sm font-medium text-red-600';
                return;
            }

            // Gather new mappings and validate Rationales
            const newMappingsToAdd = [];
            let validationError = false;
            let hasSelection = false;

            const items = addSafeguardsList.querySelectorAll('.safeguard-checkbox-item');
            items.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const rationaleInput = item.querySelector('.safeguard-rationale-input');

                if (checkbox.checked) {
                    hasSelection = true;
                    const rationaleVal = rationaleInput.value.trim();
                    if (!rationaleVal) {
                        validationError = true;
                        rationaleInput.classList.add('border-red-500', 'bg-red-50'); // Visual error cue
                    } else {
                        rationaleInput.classList.remove('border-red-500', 'bg-red-50');
                        newMappingsToAdd.push({
                            ToolID: toolID,
                            SafeguardID: checkbox.value,
                            Rationale: rationaleVal
                        });
                    }
                } else {
                     rationaleInput.classList.remove('border-red-500', 'bg-red-50');
                }
            });

            if (!hasSelection) {
                 mappingStatus.textContent = 'Please select at least one safeguard.';
                 mappingStatus.className = 'mt-2 text-sm font-medium text-red-600';
                 return;
            }

            if (validationError) {
                mappingStatus.textContent = 'Error: Rationale is required for all selected safeguards.';
                mappingStatus.className = 'mt-2 text-sm font-medium text-red-600';
                return;
            }

            // Process valid mappings
            let addedCount = 0;
            let skippedCount = 0;

            newMappingsToAdd.forEach(nm => {
                 if (mapping.some(m => m.ToolID === nm.ToolID && m.SafeguardID === nm.SafeguardID)) {
                    skippedCount++;
                    // Optional: Update rationale of existing one? Current logic just skips.
                } else {
                    mapping.push(nm);
                    addedCount++;
                }
            });
            
            mappingStatus.textContent = `Added ${addedCount} new mapping(s). ${skippedCount} skipped (already existed). Total mappings: ${mapping.length}.`;
            mappingStatus.className = 'mt-2 text-sm font-medium text-green-600';
            
            mappingForm.reset();
            // Re-render list to clear selections and hidden inputs
            renderSafeguardsList(addSafeguardsList, 'add');
        });

        // --- Modify Mode Logic ---

        modifyToolSelect.addEventListener('change', (e) => {
            currentModifyToolId = e.target.value;
            if (currentModifyToolId) {
                loadToolForEditing(currentModifyToolId);
                modifyFormContainer.classList.remove('hidden');
            } else {
                modifyFormContainer.classList.add('hidden');
            }
        });

        function loadToolForEditing(toolId) {
            const tool = tools.find(t => t.ID === toolId);
            if (!tool) return;

            // 1. Populate Tool Attribute fields
            modifyToolId.value = tool.ID;
            modifyToolName.value = tool.Name;
            modifyToolDesc.value = tool.Description;
            modifyToolUrl.value = tool.URL;
            modifyToolEducationUse.value = tool.EducationUse ? 'true' : 'false';
            modifyToolCost.value = tool.Cost || '$';

            // 2. Populate Safeguard List with Rationale Inputs using SHARED renderer
            renderSafeguardsList(modifySafeguardsList, 'mod', toolId);
        }

        // "Save Changes" button in Modify Mode
        saveChangesBtn.addEventListener('click', () => {
            if (!currentModifyToolId) return;

            // 1. Save Tool Attribute changes
            const toolIndex = tools.findIndex(t => t.ID === currentModifyToolId);
            if (toolIndex > -1) {
                tools[toolIndex].Name = modifyToolName.value;
                tools[toolIndex].Description = modifyToolDesc.value;
                tools[toolIndex].URL = modifyToolUrl.value;
                tools[toolIndex].EducationUse = modifyToolEducationUse.value === 'true'; 
                tools[toolIndex].Cost = modifyToolCost.value; 
            }

            // 2. Gather new mappings and validate Rationales
            const newMappingsForTool = [];
            let validationError = false;

            const items = modifySafeguardsList.querySelectorAll('.safeguard-checkbox-item');
            items.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const rationaleInput = item.querySelector('.safeguard-rationale-input');

                if (checkbox.checked) {
                    const rationaleVal = rationaleInput.value.trim();
                    if (!rationaleVal) {
                        validationError = true;
                        rationaleInput.classList.add('border-red-500', 'bg-red-50'); // Visual error cue
                    } else {
                        rationaleInput.classList.remove('border-red-500', 'bg-red-50');
                        newMappingsForTool.push({
                            ToolID: currentModifyToolId,
                            SafeguardID: checkbox.value,
                            Rationale: rationaleVal
                        });
                    }
                } else {
                     rationaleInput.classList.remove('border-red-500', 'bg-red-50');
                }
            });

            if (validationError) {
                setModifyStatus('Error: Rationale is required for all selected safeguards.', 'red');
                return;
            }

            // 3. Remove all old mappings for this tool
            mapping = mapping.filter(m => m.ToolID !== currentModifyToolId);

            // 4. Add all newly gathered mappings
            mapping.push(...newMappingsForTool);

            setModifyStatus('Changes saved successfully.', 'green');

            // 5. Repopulate dropdowns and re-select current tool to refresh view
            const selectedToolId = currentModifyToolId; 
            populateAddModeDropdowns();
            populateModifyToolDropdown();
            modifyToolSelect.value = selectedToolId;
            loadToolForEditing(selectedToolId); 
        });

        removeToolBtn.addEventListener('click', () => {
            if (!currentModifyToolId) return;
            
            const toolToRemove = tools.find(t => t.ID === currentModifyToolId);
            if (!toolToRemove) return;

            tools = tools.filter(t => t.ID !== currentModifyToolId);
            mapping = mapping.filter(m => m.ToolID !== currentModifyToolId);

            setModifyStatus(`Tool "${toolToRemove.Name}" and all its mappings have been removed.`, 'green');

            currentModifyToolId = null;
            modifyFormContainer.classList.add('hidden');
            populateAddModeDropdowns();
            populateModifyToolDropdown(); 
        });
        
        // --- 4. Generate Files ---
        function downloadJSON(data, filename) {
            const jsonString = JSON.stringify(data, null, 4); 
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        downloadToolsBtn.addEventListener('click', () => {
            downloadJSON(tools, 'tools.json');
        });

        downloadMappingBtn.addEventListener('click', () => {
            downloadJSON(mapping, 'mapping.json');
        });

    </script>
</body>
</html>