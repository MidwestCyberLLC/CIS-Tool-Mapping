<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCNE CIS Controls Assessment Tool</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f3f4f6; }
        .sidebar-item.active { background-color: #e0e7ff; color: #3730a3; border-right: 4px solid #3730a3; }
        .tier-card { transition: all 0.2s; }
        .tier-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        input[type="radio"]:checked + label {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        
        /* Loading Spinner */
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Inline Icons ---
        const IconWrapper = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Shield = ({ className }) => <IconWrapper className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" /></IconWrapper>;
        const LayoutDashboard = ({ className }) => <IconWrapper className={className}><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></IconWrapper>;
        const FileText = ({ className }) => <IconWrapper className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></IconWrapper>;
        const Settings = ({ className }) => <IconWrapper className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconWrapper>;
        const Upload = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></IconWrapper>;
        const Download = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></IconWrapper>;
        const ChevronRight = ({ className }) => <IconWrapper className={className}><path d="m9 18 6-6-6-6" /></IconWrapper>;
        const ChevronDown = ({ className }) => <IconWrapper className={className}><path d="m6 9 6 6 6-6" /></IconWrapper>;
        const ChevronUp = ({ className }) => <IconWrapper className={className}><path d="m18 15-6-6-6 6" /></IconWrapper>;
        const CheckCircle2 = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></IconWrapper>;
        const Info = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></IconWrapper>;
        const FileJson = ({ className }) => <IconWrapper className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><path d="M10 12a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1" /><path d="M14 12a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1" /></IconWrapper>;
        const Globe = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><line x1="2" x2="22" y1="12" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></IconWrapper>;
        const Paperclip = ({ className }) => <IconWrapper className={className}><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" /></IconWrapper>;
        const Image = ({ className }) => <IconWrapper className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></IconWrapper>;
        const Trash2 = ({ className }) => <IconWrapper className={className}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></IconWrapper>;
        const MessageSquare = ({ className }) => <IconWrapper className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></IconWrapper>;
        const BookOpen = ({ className }) => <IconWrapper className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></IconWrapper>;
        const ListChecks = ({ className }) => <IconWrapper className={className}><path d="M10 6h11" /><path d="M10 12h11" /><path d="M10 18h11" /><path d="M3 6h1" /><path d="M3 12h1" /><path d="M3 18h1" /></IconWrapper>;
        const MapPin = ({ className }) => <IconWrapper className={className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></IconWrapper>;
        const User = ({ className }) => <IconWrapper className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></IconWrapper>;
        const Calendar = ({ className }) => <IconWrapper className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></IconWrapper>;
        const Building = ({ className }) => <IconWrapper className={className}><rect x="4" y="2" width="16" height="20" rx="2" ry="2" /><line x1="9" y1="22" x2="9" y2="12" /><line x1="15" y1="12" x2="15" y2="22" /><line x1="4" y1="12" x2="20" y2="12" /><line x1="4" y1="7" x2="20" y2="7" /><line x1="4" y1="17" x2="20" y2="17" /></IconWrapper>;
        const HelpCircle = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" /></IconWrapper>;

        // --- Helper Functions ---

        const generatePlaceholders = (startId, count, tierPrefix) => {
            return Array.from({ length: count }, (_, i) => ({
                id: `${tierPrefix}.${startId + i}`,
                title: `Safeguard ${tierPrefix}.${startId + i} (Placeholder)`,
                actionPlan: "Specific control details not yet loaded. Use 'Fetch Official Mapping' to populate this data.",
                levels: {
                    1: "Initial implementation details not available.",
                    2: "Partial implementation details not available.",
                    3: "Majority implementation details not available.",
                    4: "Complete implementation details not available."
                },
                selectedLevel: null,
                evidence: {
                    notes: "",
                    attachments: []
                },
                rubricDescription: null 
            }));
        };

        const calculateTierScore = (tier) => {
            let score = 0;
            let answered = 0;
            let nas = 0;
            
            tier.controls.forEach(c => {
                const val = c.selectedLevel;
                if (val === 'N/A') {
                    nas++;
                } else if (val) {
                    score += (parseInt(val) * 0.25);
                    answered++;
                }
            });
            return { score, answered, nas };
        };

        // Evidence helper to limit file size (500KB limit for browser storage safety)
        const FILE_SIZE_LIMIT = 500 * 1024;

        const INITIAL_DATA = [
            {
                id: 1, name: "Tier 1", description: "Foundational Controls (Subset of IG1)", maxScore: 15, controls: [
                    {
                        id: "1.1",
                        title: "Establish and Maintain Detailed Enterprise Asset Inventory",
                        actionPlan: "Establish and maintain an accurate, detailed, and up-to-date inventory of all enterprise assets with the potential to store or process data.",
                        levels: { 
                            1: "No comprehensive inventory of enterprise assets exists, including end-user devices, network devices, non-computing/IoT devices, and servers.", 
                            2: "An incomplete inventory is maintained, with some assets listed but lacking essential details such as hardware address or department ownership. Review and update process is not regularly conducted.", 
                            3: "Inventory exists but the update process is not regular or thorough. Some assets may be missing or details outdated.", 
                            4: "Comprehensive, up-to-date inventory exists and is reviewed bi-annually or more frequently. Records include network address, hardware address, machine name, owner, and department." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(2, 14, 1)
                ]
            },
            {
                id: 2, name: "Tier 2", description: "Foundational Controls (IG1/IG2)", maxScore: 11, controls: [
                    {
                        id: "1.2",
                        title: "Address Unauthorized Assets",
                        actionPlan: "Ensure that a process exists to address unauthorized assets on a weekly basis.",
                        levels: { 
                            1: "No process exists to address unauthorized assets on a weekly basis. There is no documentation or evidence of efforts to identify and mitigate risks posed by these assets.", 
                            2: "The organization has some awareness of unauthorized assets, but lacks a consistent process to address them. Procedures exist, but are not followed or implemented consistently.", 
                            3: "Unauthorized assets remain active on the network due to inconsistent remediation efforts. Some measures are taken, but documentation and enforcement are lacking.", 
                            4: "A comprehensive process exists to identify and address unauthorized assets weekly. The organization documents their efforts, removes or quarantines assets, and regularly monitors and reports on their remediation activities." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "6.3",
                        title: "Require MFA for Externally-Exposed Applications",
                        actionPlan: "Require all externally-exposed enterprise or third-party applications to enforce Multi-Factor Authentication (MFA).",
                        levels: { 1: "None", 2: "Some", 3: "Most", 4: "All" },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "17.2",
                        title: "Establish and Maintain Contact Information for Reporting Security Incidents",
                        actionPlan: "Establish and maintain contact information for parties that need to be informed of security incidents.",
                        levels: { 
                            1: "No contact information exists for reporting security incidents to relevant parties.", 
                            2: "Some contact information is established for reporting security incidents, but it is incomplete, outdated, or not thoroughly verified.", 
                            3: "Contact information is updated periodically, but only basic changes are made. Verification of contacts is infrequent.", 
                            4: "Comprehensive contact information exists for all relevant parties to report security incidents. Contact data is regularly verified annually." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(4, 8, 2)
                ]
            },
            {
                id: 3, name: "Tier 3", description: "Foundational Controls", maxScore: 16, controls: [
                    {
                        id: "2.3",
                        title: "Address Unauthorized Software",
                        actionPlan: "Ensure that unauthorized software is either removed from use on enterprise assets or receives a documented exception.",
                        levels: { 
                            1: "The organization has no process in place to address unauthorized software usage, leaving it vulnerable to potential threats.", 
                            2: "Unauthorized software is removed from use on enterprise assets, but there are no documented exceptions for its removal.", 
                            3: "Unauthorized software is removed from use or receives a documented exception for continued access. However, this process lacks regular review.", 
                            4: "Regular monthly reviews (or more frequently) ensure unauthorized software is either removed from use or has a documented exception." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "3.2",
                        title: "Establish and Maintain a Data Inventory",
                        actionPlan: "Establish and maintain a data inventory based on the enterprise’s data management process.",
                        levels: { 
                            1: "The organization does not have a data inventory or a process in place.", 
                            2: "Partial inventory exists but is incomplete.", 
                            3: "Inventory exists but updates are lacking.", 
                            4: "Complete inventory, updated annually." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "14.6",
                        title: "Train Workforce Members on Recognizing and Reporting Security Incidents",
                        actionPlan: "Train workforce members to be able to recognize a potential incident and be able to report such an incident.",
                        levels: { 
                            1: "There is no formal training program in place to educate workforce members on recognizing and reporting security incidents.", 
                            2: "Workforce members receive basic training on what constitutes a security incident, including types of incidents (e.g., unauthorized access) and how to report them. However, no specific procedures are outlined.", 
                            3: "A standardized incident reporting process is established. Basic training on the process is provided, but incident response procedures are not detailed.", 
                            4: "All workforce members participate in comprehensive security awareness training, including recognition of potential incidents and procedures for reporting them." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                     ...generatePlaceholders(4, 13, 3)
                ]
            },
            {
                id: 4, name: "Tier 4", description: "Equivalent to IG1 Completion", maxScore: 15, controls: [
                    {
                        id: "2.2",
                        title: "Ensure Authorized Software is Currently Supported",
                        actionPlan: "Ensure that only currently supported software is designated as authorized in the software inventory.",
                        levels: { 
                            1: "No process exists for ensuring authorized software is currently supported on enterprise assets.", 
                            2: "A manual review of the software inventory occurs quarterly, but exceptions for unsupported software are not documented or approved.", 
                            3: "Currently supported software is designated as authorized, and exceptions for unsupported software are documented. However, documentation may be incomplete.", 
                            4: "Regular reviews (monthly or more frequently) ensure that all enterprise assets have only currently supported software designated as authorized." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "3.3",
                        title: "Configure Data Access Control Lists",
                        actionPlan: "Configure data access control lists (ACLs) based on a user’s need to know.",
                        levels: { 1: "None", 2: "Basic", 3: "Most", 4: "Comprehensive" },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "17.1",
                        title: "Designate Personnel to Manage Incident Handling",
                        actionPlan: "Designate one or more personnel to manage incident handling.",
                        levels: { 
                            1: "No designated personnel exist to manage incident handling.", 
                            2: "A single person has been designated to manage the enterprise's incident handling process, but there are no backups.", 
                            3: "Two personnel have been designated to manage the enterprise's incident handling process, including at least one backup.", 
                            4: "A dedicated team of two or more personnel has been established to manage the enterprise's incident handling process." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(4, 12, 4)
                ]
            },
            {
                id: 5, name: "Tier 5", description: "Mid-level Controls (IG2)", maxScore: 25, controls: [
                     {
                        id: "3.7",
                        title: "Establish and Maintain a Data Classification Scheme",
                        actionPlan: "Establish and maintain an overall data classification scheme for the enterprise.",
                        levels: { 
                            1: "No data classification scheme exists.", 
                            2: "A basic data classification scheme has been established using labels such as 'Sensitive' and 'Confidential.' However, the scheme is not reviewed or updated regularly.", 
                            3: "An organized data classification scheme has been implemented, with clear labels. The scheme is reviewed annually, but changes are not always reflected promptly.", 
                            4: "A comprehensive and regularly updated data classification scheme exists, with clear guidelines, labels, and procedures for ensuring confidentiality and integrity." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(2, 24, 5)
                ]
            },
            {
                id: 6, name: "Tier 6", description: "Mid-level Controls (IG2)", maxScore: 25, controls: [
                     {
                        id: "2.5",
                        title: "Allowlist Authorized Software",
                        actionPlan: "Use technical controls, such as application allowlisting, to ensure that only authorized software can execute or be accessed.",
                        levels: { 
                            1: "No technical controls in place, such as allowlisting, to restrict unauthorized software access.", 
                            2: "Basic application allowlisting implemented, but only for a limited subset of approved applications.", 
                            3: "Comprehensive application allowlisting is in place, covering all authorized software. Reviewed every two years.", 
                            4: "All aspects of application allowlisting are met, including continuous monitoring and updates." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "3.11",
                        title: "Encrypt Sensitive Data At Rest",
                        actionPlan: "Encrypt sensitive data at rest on servers, applications, and databases.",
                        levels: { 1: "None", 2: "Partial", 3: "Majority", 4: "Complete" },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "18.3",
                        title: "Remediate Penetration Test Findings",
                        actionPlan: "Remediate penetration test findings based on the enterprise’s documented vulnerability remediation process.",
                        levels: { 
                            1: "No documented vulnerability remediation process is in place.", 
                            2: "A basic remediation process exists, but it lacks detail or specific guidance on timelines and levels of effort.", 
                            3: "The documented vulnerability remediation process is comprehensive, but findings are not prioritized or addressed within a reasonable timeline.", 
                            4: "All penetration test findings are thoroughly assessed, prioritized, and remediated according to the documented process." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(4, 22, 6)
                ]
            },
            {
                id: 7, name: "Tier 7", description: "Equivalent to IG2 Completion", maxScore: 24, controls: [
                    {
                        id: "1.3",
                        title: "Utilize an Active Discovery Tool",
                        actionPlan: "Utilize an active discovery tool to identify assets connected to the enterprise’s network.",
                        levels: { 
                            1: "The organization does not utilize any active discovery tools.", 
                            2: "The organization has implemented an active discovery tool that identifies some, but not all, connected assets.", 
                            3: "The organization utilizes an active discovery tool that identifies the vast majority of connected assets. The tool executes nightly or more frequently.", 
                            4: "The organization has implemented a comprehensive active discovery tool that identifies all connected assets on their network in real-time." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "1.4",
                        title: "Use DHCP Logging to Update Asset Inventory",
                        actionPlan: "Use Dynamic Host Configuration Protocol (DHCP) logging on all DHCP servers.",
                        levels: { 1: "None", 2: "Enabled", 3: "Reviewed", 4: "Automatic" },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                     {
                        id: "17.8",
                        title: "Conduct Post-Incident Reviews",
                        actionPlan: "Conduct post-incident reviews to prevent incident recurrence.",
                        levels: { 
                            1: "No post-incident review process exists, and no lessons are learned from past incidents.", 
                            2: "Some post-incident reviews occur, but details are not documented or shared with relevant parties.", 
                            3: "Regular post-incident reviews are conducted, and basic incident data is documented. However, no follow-up action is taken.", 
                            4: "Post-incident reviews are thorough, complete, and timely, with lessons learned applied to prevent future incidents." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(4, 21, 7)
                ]
            },
             {
                id: 8, name: "Tier 8", description: "Advanced Controls (IG3)", maxScore: 7, controls: [
                    {
                        id: "3.13",
                        title: "Deploy a Data Loss Prevention Solution",
                        actionPlan: "Implement an automated tool, such as a host-based Data Loss Prevention (DLP) tool.",
                        levels: { 
                            1: "No DLP solution is deployed, and data loss prevention processes do not exist.", 
                            2: "A basic DLP tool is deployed, but it only scans on-premises assets.", 
                            3: "An automated DLP tool is implemented to scan all enterprise assets. However, the solution does not update the inventory regularly.", 
                            4: "A comprehensive DLP solution is deployed to identify and protect all sensitive data stored, processed, or transmitted through enterprise assets." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "4.12",
                        title: "Separate Enterprise Workspaces on Mobile End-User Devices",
                        actionPlan: "Ensure that enterprise workspaces on mobile end-user devices are separated from personal workspaces.",
                        levels: { 1: "None", 2: "Partial", 3: "Most", 4: "Complete" },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "15.6",
                        title: "Monitor Service Providers",
                        actionPlan: "Monitor service providers consistent with the enterprise’s service provider management policy.",
                        levels: { 
                            1: "No process exists to monitor service providers.", 
                            2: "A basic monitoring system is in place, but it only includes periodic reassessment of service provider compliance reports.", 
                            3: "The organization has implemented a standardized monitoring process that includes regular assessments of service provider compliance.", 
                            4: "The enterprise has developed a comprehensive service provider management policy and implements a robust monitoring system." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(4, 4, 8)
                ]
            },
            {
                id: 9, name: "Tier 9", description: "Advanced Controls (IG3)", maxScore: 7, controls: [
                    {
                        id: "12.8",
                        title: "Dedicated Computing Resources for Admin Work",
                        actionPlan: "Establish and maintain dedicated computing resources for all administrative tasks.",
                        levels: { 
                            1: "There is no dedicated computing resource for administrative work.", 
                            2: "Administrative resources are physically separated from the enterprise's primary network but internet access is allowed.", 
                            3: "Administrative resources are logically separated from the enterprise's primary network using firewalls and access controls.", 
                            4: "Dedicated computing resources are both physically and logically separated from the enterprise's primary network." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "13.7",
                        title: "Deploy a Host-Based Intrusion Prevention Solution",
                        actionPlan: "Deploy a host-based intrusion prevention solution on enterprise assets.",
                        levels: { 1: "None", 2: "Partial", 3: "Majority", 4: "Full" },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "18.5",
                        title: "Perform Periodic Internal Penetration Tests",
                        actionPlan: "Perform periodic internal penetration tests based on program requirements.",
                        levels: { 
                            1: "No periodic internal penetration tests are performed.", 
                            2: "Internal penetration tests are conducted annually, but only as required by program management.", 
                            3: "Periodic internal penetration tests are performed two or three times annually, using a standardized framework.", 
                            4: "Regular internal penetration tests are conducted at least quarterly to ensure ongoing program security posture." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(4, 4, 9)
                ]
            },
            {
                id: 10, name: "Tier 10", description: "Equivalent to IG3 Completion", maxScore: 8, controls: [
                    {
                        id: "1.5",
                        title: "Use a Passive Asset Discovery Tool",
                        actionPlan: "Use a passive discovery tool to identify assets connected to the enterprise’s network.",
                        levels: { 
                            1: "No passive asset discovery tool is used.", 
                            2: "A passive asset discovery tool is used, but scans are not conducted regularly.", 
                            3: "Passive asset discovery tools are used to identify and update the enterprise's asset inventory on a weekly basis.", 
                            4: "A passive asset discovery tool is continuously monitored, and scans are conducted frequently (e.g., daily)." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                     {
                        id: "2.7",
                        title: "Allowlist Authorized Scripts",
                        actionPlan: "Use technical controls to ensure that only authorized scripts are allowed to execute.",
                        levels: { 1: "None", 2: "Partial", 3: "Majority", 4: "Complete" },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    {
                        id: "18.4",
                        title: "Validate Security Measures",
                        actionPlan: "Validate security measures after each penetration test.",
                        levels: { 
                            1: "The organization has no formal process in place to validate security measures after each penetration test.", 
                            2: "After each penetration test, the organization reviews the results but no modifications are made.", 
                            3: "Following each penetration test, the organization validates security measures against known threats and modifies rulesets.", 
                            4: "The organization has a formal process in place to validate security measures after each penetration test." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(4, 5, 10)
                ]
            }
        ];

        const MAP_URL = "https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/main/safeguards.json";
        const ASSESSMENT_TYPES_URL = "https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/main/assessmentType.json";
        const RUBRIC_URL = "https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/main/rubric.json";

        // --- Components ---

        const EvidenceSection = ({ evidence = { notes: "", attachments: [] }, onChange, showNotify }) => {
            const fileInputRef = useRef(null);
            const imageInputRef = useRef(null);

            const handleFileRead = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > FILE_SIZE_LIMIT) {
                    showNotify("File too large. Max size is 500KB to ensure data saves correctly.", true);
                    e.target.value = "";
                    return;
                }

                const reader = new FileReader();
                reader.onload = (ev) => {
                    const newAttachment = {
                        id: Date.now(),
                        name: file.name,
                        type: type === 'image' ? 'image' : 'file',
                        data: ev.target.result
                    };
                    const updatedAttachments = [...(evidence.attachments || []), newAttachment];
                    onChange({ ...evidence, attachments: updatedAttachments });
                };
                reader.readAsDataURL(file);
                e.target.value = ""; 
            };

            const removeAttachment = (id) => {
                const updatedAttachments = evidence.attachments.filter(a => a.id !== id);
                onChange({ ...evidence, attachments: updatedAttachments });
            };

            return (
                <div className="mt-6 bg-gray-50 rounded-lg p-4 border border-gray-200 animate-fade-in">
                    <h4 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <Paperclip className="w-4 h-4" /> Evidence & Documentation
                    </h4>
                    <div className="mb-4">
                        <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">Notes / Comments</label>
                        <textarea 
                            className="w-full p-2 border rounded-md text-sm focus:ring-2 focus:ring-indigo-500 outline-none" 
                            rows="2"
                            placeholder="Add implementation details, gaps, or justification..."
                            value={evidence.notes || ""}
                            onChange={(e) => onChange({ ...evidence, notes: e.target.value })}
                        ></textarea>
                    </div>
                    <div className="flex gap-3 mb-4">
                        <button onClick={() => imageInputRef.current.click()} className="flex items-center gap-2 px-3 py-1.5 bg-white border rounded text-xs text-gray-700 hover:bg-gray-50">
                            <Image className="w-3 h-3" /> Add Picture
                        </button>
                        <input type="file" accept="image/*" ref={imageInputRef} className="hidden" onChange={(e) => handleFileRead(e, 'image')} />
                        <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-3 py-1.5 bg-white border rounded text-xs text-gray-700 hover:bg-gray-50">
                            <FileText className="w-3 h-3" /> Attach File
                        </button>
                         <input type="file" ref={fileInputRef} className="hidden" onChange={(e) => handleFileRead(e, 'file')} />
                    </div>
                    {evidence.attachments && evidence.attachments.length > 0 && (
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            {evidence.attachments.map(att => (
                                <div key={att.id} className="flex items-center justify-between p-2 bg-white border rounded shadow-sm text-sm">
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        {att.type === 'image' ? (
                                            <img src={att.data} alt="preview" className="w-8 h-8 object-cover rounded bg-gray-100" />
                                        ) : (
                                            <div className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded text-gray-500"><FileText className="w-4 h-4" /></div>
                                        )}
                                        <span className="truncate max-w-[150px]" title={att.name}>{att.name}</span>
                                    </div>
                                    <button onClick={() => removeAttachment(att.id)} className="text-red-400 hover:text-red-600 p-1"><Trash2 className="w-4 h-4" /></button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const ControlCard = ({ control, tierIndex, cIdx, updateControl, showNotify }) => {
            const [isRubricOpen, setIsRubricOpen] = useState(false);

            return (
                <div className="bg-white rounded-xl shadow-sm border overflow-hidden p-6 transition-all hover:shadow-md">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <span className="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded font-bold mb-2">Safeguard {control.id}</span>
                            <h3 className="text-lg font-bold text-gray-900">{control.title}</h3>
                        </div>
                    </div>
                    
                    <div className="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-100">
                        <div className="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 flex items-center gap-2">
                            <Settings className="w-4 h-4" /> Description
                        </div>
                        <p className="text-gray-600 text-sm leading-relaxed mb-3">{control.actionPlan}</p>
                        
                        <button 
                            onClick={() => setIsRubricOpen(!isRubricOpen)}
                            className="text-xs flex items-center gap-1 text-indigo-600 hover:text-indigo-800 font-medium transition-colors"
                        >
                            <BookOpen className="w-3 h-3" /> 
                            {isRubricOpen ? "Hide Rubric Description" : "Rubric Description"}
                            <ChevronDown className={`w-3 h-3 transition-transform ${isRubricOpen ? 'rotate-180' : ''}`} />
                        </button>

                        {isRubricOpen && (
                            <div className="mt-4 grid grid-cols-1 gap-3 pt-3 border-t border-gray-200 animate-fade-in">
                                <div className="text-xs">
                                    <span className="font-bold text-red-600 block mb-1">Level 1 (Initial)</span>
                                    <span className="text-gray-600">{control.levels[1]}</span>
                                </div>
                                <div className="text-xs">
                                    <span className="font-bold text-yellow-600 block mb-1">Level 2 (Partial)</span>
                                    <span className="text-gray-600">{control.levels[2]}</span>
                                </div>
                                <div className="text-xs">
                                    <span className="font-bold text-blue-600 block mb-1">Level 3 (Majority)</span>
                                    <span className="text-gray-600">{control.levels[3]}</span>
                                </div>
                                <div className="text-xs">
                                    <span className="font-bold text-green-600 block mb-1">Level 4 (Complete)</span>
                                    <span className="text-gray-600">{control.levels[4]}</span>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="space-y-3">
                        <div className="text-xs font-semibold text-gray-400 uppercase">Self Score</div>
                        <div className="grid grid-cols-1 sm:grid-cols-5 gap-3">
                            {[1, 2, 3, 4, 'N/A'].map((level) => {
                                const val = level === 'N/A' ? 'N/A' : level;
                                const isSelected = control.selectedLevel == val;
                                let label = level === 'N/A' ? 'N/A' : `Level ${level}`;
                                let points = level === 'N/A' ? '' : `(${level * 0.25} pts)`;
                                let activeClass = "";
                                if (isSelected) {
                                    if(level === 1) activeClass = "bg-red-500 border-red-500 text-white";
                                    else if(level === 2) activeClass = "bg-orange-500 border-orange-500 text-white";
                                    else if(level === 3) activeClass = "bg-blue-500 border-blue-500 text-white";
                                    else if(level === 4) activeClass = "bg-green-500 border-green-500 text-white";
                                    else activeClass = "bg-gray-500 border-gray-500 text-white";
                                } else {
                                    activeClass = "bg-white text-gray-600 hover:border-indigo-300";
                                }

                                return (
                                    <button
                                        key={level}
                                        onClick={() => updateControl(tierIndex, cIdx, { selectedLevel: val })}
                                        className={`flex flex-col items-center justify-center p-3 rounded-lg border transition-all ${activeClass}`}
                                    >
                                        <span className="font-bold">{label}</span>
                                        <span className="text-xs opacity-80">{points}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {control.selectedLevel && control.selectedLevel !== 'N/A' && (
                        <div className="mt-4 pt-4 border-t text-sm text-gray-600 animate-fade-in">
                            <span className="font-semibold text-gray-800">Current Level Definition:</span> {control.levels[control.selectedLevel]}
                        </div>
                    )}

                    {control.selectedLevel && (
                        <EvidenceSection 
                            evidence={control.evidence || { notes: "", attachments: [] }}
                            onChange={(newEvidence) => updateControl(tierIndex, cIdx, { evidence: newEvidence })}
                            showNotify={showNotify}
                        />
                    )}
                </div>
            );
        };

        const Sidebar = ({ view, setView, loading, handleUrlFetch, selectedTypeID, handleTypeChange, isMapLoaded, assessmentTypes, data, downloadData, handleMappingUpload, handleFileUpload }) => {
            const areTiersDisabled = !isMapLoaded || !selectedTypeID;

            return (
                <div className="w-64 bg-white border-r h-screen fixed overflow-y-auto flex flex-col shadow-lg z-10">
                    <div className="p-6 border-b flex items-center gap-3">
                        <Shield className="w-8 h-8 text-indigo-600" />
                        <div>
                            <h1 className="font-bold text-gray-800">NCNE / CIS</h1>
                            <p className="text-xs text-gray-500">Assessment Tool</p>
                        </div>
                    </div>
                    <nav className="flex-1 p-4 flex flex-col space-y-1">
                        
                        <div className="px-4 pb-4">
                            <button onClick={handleUrlFetch} disabled={loading} className="w-full flex items-center justify-center p-2 bg-indigo-600 border border-indigo-700 rounded text-xs text-white hover:bg-indigo-700 transition gap-2 shadow-sm">
                                {loading ? <div className="spinner"></div> : <Globe className="w-4 h-4" />}
                                Fetch Official Mapping
                            </button>
                        </div>

                        <div className="px-4 pb-4">
                            <label className="block text-xs font-medium text-gray-500 mb-1">Assessment Type</label>
                            <select 
                                value={selectedTypeID} 
                                onChange={handleTypeChange}
                                disabled={!isMapLoaded}
                                className={`w-full p-2 bg-white border rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none ${!isMapLoaded ? 'opacity-50 cursor-not-allowed bg-gray-100' : ''}`}
                            >
                                <option value="">Select Type...</option>
                                {assessmentTypes.map((type, i) => (
                                    <option key={i} value={type.TypeID}>{type.Type}</option>
                                ))}
                            </select>
                        </div>

                        <button onClick={() => setView('intro')} className={`sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'intro' ? 'active' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <Info className="w-4 h-4" /> Introduction
                        </button>

                        <button onClick={() => setView('info')} className={`sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'info' ? 'active' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <Building className="w-4 h-4" /> Assessment Information
                        </button>
                        
                        <button 
                            onClick={() => !areTiersDisabled && setView('score')} 
                            disabled={areTiersDisabled}
                            className={`sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'score' ? 'active' : ''} ${areTiersDisabled ? 'opacity-50 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-50'}`}
                        >
                            <LayoutDashboard className="w-4 h-4" /> Score & Dashboard
                        </button>

                        <div className="pt-4 pb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider px-4">Tiers</div>
                        {data.map((tier, idx) => (
                            <button 
                                key={tier.id} 
                                onClick={() => !areTiersDisabled && setView(`tier-${idx}`)} 
                                disabled={areTiersDisabled}
                                className={`sidebar-item w-full flex items-center justify-between px-4 py-2.5 rounded-lg text-sm font-medium ${view === `tier-${idx}` ? 'active' : ''} ${areTiersDisabled ? 'opacity-50 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-50'}`}
                            >
                                <span className="flex items-center gap-2">
                                    <span className="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">{tier.id}</span>
                                    {tier.name}
                                </span>
                                {calculateTierScore(tier).score > 0 && <CheckCircle2 className="w-3 h-3 text-green-500"/>}
                            </button>
                        ))}
                        <button onClick={() => setView('summary')} className={`sidebar-item mt-4 w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'summary' ? 'active' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <FileText className="w-4 h-4" /> Full Summary
                        </button>

                        <button onClick={() => setView('about')} className={`sidebar-item mt-auto w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'about' ? 'active' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <HelpCircle className="w-4 h-4" /> About
                        </button>
                    </nav>
                    <div className="p-4 border-t bg-gray-50">
                        <div className="space-y-2">
                            <label className="flex items-center justify-center p-2 bg-indigo-50 border border-indigo-200 rounded text-xs text-indigo-700 hover:bg-indigo-100 transition cursor-pointer gap-2">
                                <FileJson className="w-4 h-4" /> Upload Map File
                                <input type="file" className="hidden" accept=".json" onChange={handleMappingUpload}/>
                            </label>

                            <div className="grid grid-cols-2 gap-2 mt-2">
                                <button onClick={downloadData} className="flex flex-col items-center justify-center p-2 bg-white border rounded text-xs text-gray-600 hover:bg-gray-50 transition">
                                    <Download className="w-4 h-4 mb-1" /> Save
                                </button>
                                <label className="flex flex-col items-center justify-center p-2 bg-white border rounded text-xs text-gray-600 hover:bg-gray-50 transition cursor-pointer">
                                    <Upload className="w-4 h-4 mb-1" /> Load
                                    <input type="file" className="hidden" accept=".json" onChange={handleFileUpload}/>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AboutView = () => (
            <div className="max-w-4xl mx-auto space-y-6">
                <div className="bg-white p-8 rounded-xl shadow-sm border">
                    <h2 className="text-2xl font-bold text-gray-900 mb-8 text-center">About the CIS Cybersecurity Assessment Tool</h2>
                    
                    {/* Logos */}
                    <div className="flex justify-center gap-8 mb-10">
                        <div className="w-32 h-32 bg-gray-50 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-200 p-2">
                            <img src="https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/refs/heads/main/images/NCNELogo.png" alt="Organization Logo 1" className="max-w-full max-h-full object-contain" />
                        </div>
                        <div className="w-32 h-32 bg-gray-50 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-200 p-2">
                            <img src="https://github.com/MidwestCyberLLC/CIS-Tool-Mapping/blob/main/images/CISLogo.png?raw=true" alt="Organization Logo 2" className="max-w-full max-h-full object-contain" />
                        </div>
                        <div className="w-32 h-32 bg-gray-50 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-200 p-2">
                            <img src="https://github.com/MidwestCyberLLC/CIS-Tool-Mapping/blob/main/images/MidwestCyberLogo.png?raw=true" alt="Organization Logo 3" className="max-w-full max-h-full object-contain" />
                        </div>
                    </div>

                    <div className="prose max-w-none text-gray-600 space-y-6">
                        <div>
                            <h3 className="text-lg font-semibold text-gray-800 mb-2">Mission Statement</h3>
                            <p className="leading-relaxed">
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                            </p>
                        </div>
                        
                        <hr className="border-gray-100" />

                        <div>
                            <h3 className="text-lg font-semibold text-gray-800 mb-2">Support & Contact</h3>
                            <p className="leading-relaxed">
                                Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.
                            </p>
                        </div>

                        <hr className="border-gray-100" />
                        
                        <div className="flex justify-between items-end pt-4 text-sm text-gray-400">
                            <div>
                                <p>Tool Version: 1.0.5</p>
                                <p>Last Updated: November 2025</p>
                            </div>
                            <div className="text-right">
                                <p>&copy; 2025 NCNE / CIS Assessment Tool</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const IntroductionView = ({ setView }) => (
            <div className="w-[75%] mx-auto space-y-6">
                <div className="bg-white p-8 rounded-xl shadow-sm border">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4">Welcome to the CIS Controls Assessment</h2>
                    <div className="prose text-gray-600 space-y-4">
                        <p>The CIS Critical Security Controls (CIS Controls) are a prioritized set of Safeguards to mitigate the most prevalent cyber attacks against systems and networks. They are mapped to and referenced by multiple legal, regulatory, and policy frameworks.  Given the number of publicly available cybersecurity frameworks, the Nebraska Cybersecurity Network for Education (NCNE) is currently recommending schools and small organizations use an adapted variation of the CIS Controls.  These adaptations are outlined in this document.</p>
                        <p>The CIS Controls is natively broken into 3 sets of controls, known as Implementation Group 1 (IG1) with 57 total controls, Implementation Group 2 (IG2) with 131 total controls and Implementation Group 3 (IG3) with all 153 controls. The controls are logically grouped with the more foundational, and arguably easier, controls to implement are positioned in IG1.  IG2 adds more mid-level controls, and IG3 adds the final set of more difficult controls.</p>
                        
                        <h3 className="text-lg font-semibold text-gray-800 pt-2">How it works</h3>
                        <p>The NCNE adaptation of the CIS Controls is merely to further segment the controls within IG1, IG2 and IG3 into smaller groups, called tiers.  There are a total of 10 tiers, organized so that Tier 4 is the equivalent of IG1, Tier 7 is the equivalent of IG2 and Tier 10 is the equivalent of IG3.  The controls contained in each Tier are designed to be grouped so that implementation of each control is more similar than different.</p>
                        <p>On the Score tab will be a summary of the calculated scores from each of the Tiers.  Multiple score calculations will be provided to help to paint a picture of level and quality of the controls implemented.  Each control is scored on a 4-level grading system.  Points are awarded based on the level identified, with:
                        <br />
                        <ul className="list-disc pl-5 ml-4">
                            <li>0.25 points for Level 1</li>
                            <li>0.50 points for Level 2</li>
                            <li>0.75 points for Level 3</li>
                            <li>1.00 points for Level 4</li>
                        </ul></p>
                        <p> Controls marked as Not Applicable (N/A) do not contribute to the score, but are tracked separately to provide context on the total number of controls assessed.  Each Tier will also provide a breakdown of the number of controls at each level, as well as those marked N/A or unassigned.</p>
                        <p>The goal of this score is to be a snapshot in time.  It should provide guidance on what controls should be implemented, roughly in which order, and details on how to implement each control.  Reassessing your organization at a later time in the future should easily be able to show the positive progress you are taking to make your organization more secure.</p>
                        
                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 my-4 text-sm text-blue-800 flex items-start gap-3">
                            <Globe className="w-5 h-5 mt-0.5 flex-shrink-0" />
                            <div>
                                <strong>Latest Framework Data:</strong> Click the <span className="font-bold text-indigo-700">Fetch Official Mapping</span> button in the sidebar to automatically download and populate the latest Controls, Titles, and Descriptions directly from the MidwestCyberLLC GitHub repository.
                            </div>
                        </div>

                        <div className="bg-green-50 p-4 rounded-lg border border-green-100 my-4 text-sm text-green-800 flex items-start gap-3">
                            <ListChecks className="w-5 h-5 mt-0.5 flex-shrink-0" />
                            <div>
                                <strong>Custom Rubrics:</strong> Select your <span className="font-bold">Assessment Type</span> from the sidebar dropdown to load specific grading criteria for each control level.
                            </div>
                        </div>

                        <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100 my-4">
                            <h4 className="font-semibold text-indigo-900 mb-2">Scoring System</h4>
                            <ul className="space-y-2 text-sm text-indigo-800">
                                <li className="flex items-center gap-2"><span className="font-bold bg-white px-2 py-0.5 rounded border border-indigo-200">Level 1</span> Initial (0.25 points)</li>
                                <li className="flex items-center gap-2"><span className="font-bold bg-white px-2 py-0.5 rounded border border-indigo-200">Level 2</span> Partial (0.50 points)</li>
                                <li className="flex items-center gap-2"><span className="font-bold bg-white px-2 py-0.5 rounded border border-indigo-200">Level 3</span> Majority (0.75 points)</li>
                                <li className="flex items-center gap-2"><span className="font-bold bg-white px-2 py-0.5 rounded border border-indigo-200">Level 4</span> Complete (1.00 points)</li>
                            </ul>
                        </div>
                        
                        <div className="mt-8 border-t pt-6">
                            <h3 className="text-lg font-bold text-gray-900 mb-4">Getting Started</h3>
                            <div className="space-y-4">
                                <div className="flex gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                    <div className="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">1</div>
                                    <div>
                                        <h4 className="font-semibold text-gray-900">Load Framework Data</h4>
                                        <p className="text-sm text-gray-600">Click <span className="font-medium text-indigo-600">Fetch Official Mapping</span> in the sidebar (top left) to download the latest controls, or use the "Upload Map File" option at the bottom if you have a custom map.</p>
                                    </div>
                                </div>
                                <div className="flex gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                    <div className="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">2</div>
                                    <div>
                                        <h4 className="font-semibold text-gray-900">Select Assessment Type</h4>
                                        <p className="text-sm text-gray-600">Choose your organization's specific assessment type from the dropdown menu in the sidebar to ensure the correct grading rubrics are loaded.</p>
                                    </div>
                                </div>
                                <div className="flex gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                    <div className="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">3</div>
                                    <div>
                                        <h4 className="font-semibold text-gray-900">Begin Assessment</h4>
                                        <p className="text-sm text-gray-600">Navigate to <strong>Tier 1</strong> in the sidebar menu to start evaluating your safeguards. Proceed through the tiers sequentially.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const ScoreView = ({ aggregates, data, setView }) => (
            <div className="max-w-6xl mx-auto space-y-6">
                {/* Top Stats */}
                <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-purple-100 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10">
                            <Shield className="w-16 h-16 text-purple-600" />
                        </div>
                        <div className="text-sm text-gray-500 font-medium">Current Rank</div>
                        <div className="text-3xl font-bold text-purple-600 mt-2">Tier {aggregates.tierRank}</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border">
                        <div className="text-sm text-gray-500 font-medium">Total Score</div>
                        <div className="text-3xl font-bold text-indigo-600 mt-2">{aggregates.totalScore.toFixed(2)} <span className="text-gray-400 text-lg">/ {aggregates.totalMax}</span></div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border">
                        <div className="text-sm text-gray-500 font-medium">Compliance</div>
                        <div className="text-3xl font-bold text-green-600 mt-2">{aggregates.totalMax > 0 ? ((aggregates.totalScore / aggregates.totalMax) * 100).toFixed(1) : 0}%</div>
                    </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                        <div className="text-sm text-gray-500 font-medium">Controls Assessed</div>
                        <div className="text-3xl font-bold text-blue-600 mt-2">{153 - aggregates.counts.unassigned} <span className="text-gray-400 text-lg">/ 153</span></div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border">
                        <div className="text-sm text-gray-500 font-medium">Not Applicable</div>
                        <div className="text-3xl font-bold text-gray-600 mt-2">{aggregates.counts.na}</div>
                    </div>
                </div>

                {/* Breakdown Chart */}
                <div className="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 className="font-bold text-gray-800 mb-4">Implementation Levels</h3>
                    <div className="flex h-6 rounded-full overflow-hidden bg-gray-100">
                        <div style={{width: `${(aggregates.counts[4]/153)*100}%`}} className="bg-green-500" title="Complete"></div>
                        <div style={{width: `${(aggregates.counts[3]/153)*100}%`}} className="bg-blue-500" title="Majority"></div>
                        <div style={{width: `${(aggregates.counts[2]/153)*100}%`}} className="bg-yellow-500" title="Partial"></div>
                        <div style={{width: `${(aggregates.counts[1]/153)*100}%`}} className="bg-red-500" title="Initial"></div>
                    </div>
                    <div className="flex justify-between mt-4 text-sm text-gray-600">
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-green-500"></div> Complete ({aggregates.counts[4]})</div>
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-blue-500"></div> Majority ({aggregates.counts[3]})</div>
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-yellow-500"></div> Partial ({aggregates.counts[2]})</div>
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-red-500"></div> Initial ({aggregates.counts[1]})</div>
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-gray-200"></div> Unscored ({aggregates.counts.unassigned})</div>
                    </div>
                </div>

                {/* Detailed Tier Table */}
                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="bg-gray-50 border-b text-sm text-gray-500">
                                <th className="px-6 py-4 font-semibold">Tier</th>
                                <th className="px-6 py-4 font-semibold">Progress</th>
                                <th className="px-6 py-4 font-semibold">Score</th>
                                <th className="px-6 py-4 font-semibold text-right">Max</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((tier, i) => {
                                const stats = calculateTierScore(tier);
                                const percent = (stats.score / tier.maxScore) * 100;
                                return (
                                    <tr key={tier.id} onClick={() => setView(`tier-${i}`)} className="border-b last:border-0 hover:bg-gray-50 cursor-pointer transition">
                                        <td className="px-6 py-4">
                                            <div className="font-semibold text-gray-900">{tier.name}</div>
                                            <div className="text-xs text-gray-500">{tier.description}</div>
                                        </td>
                                        <td className="px-6 py-4 w-1/3">
                                            <div className="w-full bg-gray-200 rounded-full h-2.5">
                                                <div className="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style={{ width: `${percent}%` }}></div>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">{percent.toFixed(0)}%</div>
                                        </td>
                                        <td className="px-6 py-4 font-mono text-gray-700">{stats.score.toFixed(2)}</td>
                                        <td className="px-6 py-4 font-mono text-gray-400 text-right">{tier.maxScore}</td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        );

        const TierView = ({ tierIndex, data, updateControl, showNotify, setView }) => {
            const tier = data[tierIndex];
            const stats = calculateTierScore(tier);
            
            return (
                <div className="max-w-4xl mx-auto pb-20">
                    {/* Header */}
                    <div className="flex items-end justify-between mb-6 border-b pb-4">
                        <div>
                            <h2 className="text-3xl font-bold text-gray-900">{tier.name}</h2>
                            <p className="text-gray-500">{tier.description}</p>
                        </div>
                        <div className="text-right">
                            <div className="text-2xl font-bold text-indigo-600">{stats.score} <span className="text-gray-400 text-lg">/ {tier.maxScore}</span></div>
                            <div className="text-sm text-gray-500">Current Score</div>
                        </div>
                    </div>

                    {/* Controls List */}
                    <div className="space-y-6">
                        {tier.controls.map((control, cIdx) => (
                            <ControlCard 
                                key={control.id}
                                control={control}
                                tierIndex={tierIndex}
                                cIdx={cIdx}
                                updateControl={updateControl}
                                showNotify={showNotify}
                            />
                        ))}
                    </div>

                    {/* Navigation Footer */}
                    <div className="flex justify-between mt-8">
                        <button 
                            onClick={() => setView(tierIndex > 0 ? `tier-${tierIndex - 1}` : 'intro')}
                            className="px-6 py-3 bg-white border rounded-lg hover:bg-gray-50 text-gray-700"
                        >
                            Previous
                        </button>
                        <button 
                            onClick={() => setView(tierIndex < 9 ? `tier-${tierIndex + 1}` : 'summary')}
                            className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md flex items-center gap-2"
                        >
                            {tierIndex < 9 ? 'Next Tier' : 'Finish & View Summary'} <ChevronRight className="w-4 h-4"/>
                        </button>
                    </div>
                </div>
            );
        };

        const SummaryView = ({ data, downloadData, sortConfig, setSortConfig }) => {

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const sortedData = useMemo(() => {
                // Flatten the data structure for the table
                let flat = data.flatMap((tier) => 
                    tier.controls.map((c) => ({
                        ...c,
                        tierNum: tier.id, 
                        tierName: tier.name
                    }))
                );

                // Sort comparison function
                const compareIds = (a, b) => {
                    const partsA = a.toString().split('.').map(Number);
                    const partsB = b.toString().split('.').map(Number);
                    
                    for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
                        const valA = partsA[i] || 0;
                        const valB = partsB[i] || 0;
                        if (valA !== valB) return valA - valB;
                    }
                    return 0;
                };

                flat.sort((a, b) => {
                    let comparison = 0;
                    
                    // Primary Sorting
                    switch(sortConfig.key) {
                        case 'tier':
                            comparison = a.tierNum - b.tierNum;
                            break;
                        case 'id':
                            comparison = compareIds(a.id, b.id);
                            break;
                        case 'title':
                            comparison = a.title.localeCompare(b.title);
                            break;
                        case 'status':
                            // Sort by score value: null -> N/A -> 1 -> 2 -> 3 -> 4
                            const getLevelVal = (l) => {
                                if (l === 'N/A') return -1;
                                if (!l) return -2;
                                    return parseInt(l);
                            };
                            comparison = getLevelVal(a.selectedLevel) - getLevelVal(b.selectedLevel);
                            break;
                        case 'evidence':
                            // Sort by boolean: has notes or attachments
                            const hasEvA = (a.evidence?.notes || a.evidence?.attachments?.length) ? 1 : 0;
                            const hasEvB = (b.evidence?.notes || b.evidence?.attachments?.length) ? 1 : 0;
                            comparison = hasEvA - hasEvB;
                            break;
                        case 'points':
                            const getPoints = (l) => (l && l !== 'N/A' ? l * 0.25 : 0);
                            comparison = getPoints(a.selectedLevel) - getPoints(b.selectedLevel);
                            break;
                        default:
                            comparison = 0;
                    }

                    // Apply Sort Direction
                    if (sortConfig.direction === 'desc') {
                        comparison *= -1;
                    }

                    // Secondary Sort (Safeguard) - Always Ascending unless it is the primary key
                    if (comparison === 0 && sortConfig.key !== 'id') {
                        return compareIds(a.id, b.id);
                    }

                    return comparison;
                });

                return flat;
            }, [data, sortConfig]);

            const SortHeader = ({ label, sKey, align = "left" }) => (
                <th 
                    className={`px-4 py-3 cursor-pointer hover:bg-gray-100 transition select-none ${align === 'right' ? 'text-right' : 'text-left'}`}
                    onClick={() => handleSort(sKey)}
                >
                    <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : 'justify-start'}`}>
                        {label}
                        <span className="text-gray-400 flex flex-col items-center justify-center h-4 w-4">
                            {sortConfig.key === sKey ? (
                                sortConfig.direction === 'asc' ? <ChevronUp className="w-3 h-3 text-indigo-600" /> : <ChevronDown className="w-3 h-3 text-indigo-600" />
                            ) : (
                                <div className="flex flex-col opacity-30 group-hover:opacity-100">
                                    <ChevronUp className="w-2 h-2" />
                                    <ChevronDown className="w-2 h-2 -mt-1" />
                                </div>
                            )}
                        </span>
                    </div>
                </th>
            );

            return (
                <div className="max-w-6xl mx-auto">
                    <div className="bg-white rounded-xl shadow-lg border overflow-hidden">
                        <div className="p-6 border-b flex justify-between items-center bg-gray-50">
                            <h2 className="text-2xl font-bold text-gray-800">Complete Assessment Summary</h2>
                            <button onClick={downloadData} className="text-sm bg-white border px-3 py-1.5 rounded text-gray-600 hover:text-indigo-600">Download Report</button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 text-gray-500 font-medium border-b">
                                    <tr>
                                        <SortHeader label="Tier" sKey="tier" />
                                        <SortHeader label="Safeguard" sKey="id" />
                                        <SortHeader label="Control Title" sKey="title" />
                                        <SortHeader label="Status" sKey="status" />
                                        <SortHeader label="Evidence" sKey="evidence" />
                                        <SortHeader label="Points" sKey="points" align="right" />
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {sortedData.map((c) => (
                                        <tr key={`${c.tierNum}-${c.id}`} className="hover:bg-gray-50">
                                            <td className="px-4 py-3 font-medium text-gray-700">{c.tierName}</td>
                                            <td className="px-4 py-3 font-mono text-gray-500 font-bold">{c.id}</td>
                                            <td className="px-4 py-3 text-gray-800">{c.title}</td>
                                            <td className="px-4 py-3">
                                                {!c.selectedLevel ? <span className="text-gray-400 italic">Not Scored</span> :
                                                    c.selectedLevel === 'N/A' ? <span className="px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs font-bold">N/A</span> :
                                                    c.selectedLevel == 4 ? <span className="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold">Complete</span> :
                                                    c.selectedLevel == 3 ? <span className="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold">Majority</span> :
                                                    c.selectedLevel == 2 ? <span className="px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-xs font-bold">Partial</span> :
                                                    <span className="px-2 py-1 rounded bg-red-100 text-red-700 text-xs font-bold">Initial</span>}
                                            </td>
                                            <td className="px-4 py-3 text-gray-500">
                                                {c.evidence && c.evidence.notes && <MessageSquare className="w-4 h-4 inline-block mr-2" />}
                                                {c.evidence && c.evidence.attachments && c.evidence.attachments.length > 0 && <Paperclip className="w-4 h-4 inline-block" />}
                                            </td>
                                            <td className="px-4 py-3 text-right font-mono">
                                                {c.selectedLevel && c.selectedLevel !== 'N/A' ? (c.selectedLevel * 0.25).toFixed(2) : '-'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const AssessmentInfoView = ({ meta, updateMeta }) => {
            const handleEndAssessment = () => {
                updateMeta('endDate', new Date().toLocaleDateString());
            };

            // Basic helper to encode address for google maps embed iframe
            const mapSrc = meta.address 
                ? `https://maps.google.com/maps?q=${encodeURIComponent(meta.address)}&t=&z=13&ie=UTF8&iwloc=&output=embed`
                : "";

            return (
                <div className="max-w-4xl mx-auto space-y-6">
                    <div className="bg-white p-8 rounded-xl shadow-sm border">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                            <Building className="w-6 h-6 text-indigo-600" /> Assessment Information
                        </h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div className="col-span-2">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Organization Name</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
                                    value={meta.orgName}
                                    onChange={(e) => updateMeta('orgName', e.target.value)}
                                    placeholder="Enter Organization Name..."
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Assessment Start Date</label>
                                <div className="w-full p-2 bg-gray-100 border rounded-md text-gray-700 flex items-center gap-2">
                                    <Calendar className="w-4 h-4 text-gray-500" />
                                    {meta.startDate}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Assessment End Date</label>
                                <div className="flex gap-2">
                                    <div className="flex-1 p-2 bg-gray-100 border rounded-md text-gray-700 flex items-center gap-2 min-h-[42px]">
                                        <Calendar className="w-4 h-4 text-gray-500" />
                                        {meta.endDate || "Not Ended"}
                                    </div>
                                    <button 
                                        onClick={handleEndAssessment}
                                        className="px-4 py-2 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 transition whitespace-nowrap"
                                    >
                                        End Assessment
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="border-t pt-6 mb-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <MapPin className="w-5 h-5 text-gray-500" /> Organization Details
                            </h3>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Physical Address</label>
                                    <textarea 
                                        className="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none mb-4"
                                        rows="3"
                                        value={meta.address}
                                        onChange={(e) => updateMeta('address', e.target.value)}
                                        placeholder="1234 Main St, City, State, Zip"
                                    ></textarea>
                                    
                                    {meta.address && (
                                        <div className="w-full h-48 bg-gray-100 rounded-lg overflow-hidden border">
                                            <iframe 
                                                width="100%" 
                                                height="100%" 
                                                src={mapSrc} 
                                                frameBorder="0" 
                                                scrolling="no" 
                                                marginHeight="0" 
                                                marginWidth="0"
                                            ></iframe>
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Authorizing Individual (CIO/CISO)</label>
                                        <input 
                                            type="text" placeholder="Name" 
                                            className="w-full p-2 border rounded-md mb-2 text-sm"
                                            value={meta.authorizer.name}
                                            onChange={(e) => updateMeta('authorizer', { ...meta.authorizer, name: e.target.value })}
                                        />
                                        <div className="grid grid-cols-2 gap-2">
                                            <input 
                                                type="text" placeholder="Phone" 
                                                className="w-full p-2 border rounded-md text-sm"
                                                value={meta.authorizer.phone}
                                                onChange={(e) => updateMeta('authorizer', { ...meta.authorizer, phone: e.target.value })}
                                            />
                                            <input 
                                                type="text" placeholder="Email" 
                                                className="w-full p-2 border rounded-md text-sm"
                                                value={meta.authorizer.email}
                                                onChange={(e) => updateMeta('authorizer', { ...meta.authorizer, email: e.target.value })}
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Primary Point of Contact</label>
                                        <input 
                                            type="text" placeholder="Name" 
                                            className="w-full p-2 border rounded-md mb-2 text-sm"
                                            value={meta.poc.name}
                                            onChange={(e) => updateMeta('poc', { ...meta.poc, name: e.target.value })}
                                        />
                                        <div className="grid grid-cols-2 gap-2">
                                            <input 
                                                type="text" placeholder="Phone" 
                                                className="w-full p-2 border rounded-md text-sm"
                                                value={meta.poc.phone}
                                                onChange={(e) => updateMeta('poc', { ...meta.poc, phone: e.target.value })}
                                            />
                                            <input 
                                                type="text" placeholder="Email" 
                                                className="w-full p-2 border rounded-md text-sm"
                                                value={meta.poc.email}
                                                onChange={(e) => updateMeta('poc', { ...meta.poc, email: e.target.value })}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="mt-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Company Notes</label>
                                <textarea 
                                    className="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
                                    rows="2"
                                    value={meta.orgNotes}
                                    onChange={(e) => updateMeta('orgNotes', e.target.value)}
                                    placeholder="Brief description or notes about the company..."
                                ></textarea>
                            </div>
                        </div>

                        <div className="border-t pt-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <User className="w-5 h-5 text-gray-500" /> Assessor Details
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Assessor Name</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.name}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, name: e.target.value })}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Assessor Company</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.company}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, company: e.target.value })}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.phone || ""}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, phone: e.target.value })}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.email || ""}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, email: e.target.value })}
                                    />
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Website</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.website || ""}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, website: e.target.value })}
                                        placeholder="https://"
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Assessment Notes</label>
                                <textarea 
                                    className="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
                                    rows="4"
                                    value={meta.assessmentNotes}
                                    onChange={(e) => updateMeta('assessmentNotes', e.target.value)}
                                    placeholder="General notes regarding the assessment execution..."
                                ></textarea>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const App = () => {
            const [view, setView] = useState('intro'); 
            const [data, setData] = useState(INITIAL_DATA);
            const [notification, setNotification] = useState(null);
            const [loading, setLoading] = useState(false);
            const [assessmentTypes, setAssessmentTypes] = useState([]);
            const [selectedTypeID, setSelectedTypeID] = useState(""); // Stores the numeric TypeID
            const [isMapLoaded, setIsMapLoaded] = useState(false);
            // Lifted state for sorting configuration
            const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'asc' });

            // New State for Assessment Meta Information
            const [assessmentMeta, setAssessmentMeta] = useState({
                orgName: "",
                startDate: new Date().toLocaleDateString(),
                endDate: "",
                address: "",
                authorizer: { name: "", phone: "", email: "" },
                poc: { name: "", phone: "", email: "" },
                orgNotes: "",
                assessor: { name: "", company: "", phone: "", email: "", website: "" },
                assessmentNotes: ""
            });

            // Load from LocalStorage on Mount
            useEffect(() => {
                const savedData = localStorage.getItem('cis_assessment_data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        
                        // Load Control Data
                        let controlsData = parsed;
                        // Handle new format where data is nested
                        if (!Array.isArray(parsed) && parsed.data) {
                            controlsData = parsed.data;
                        }

                        if(controlsData && Array.isArray(controlsData) && controlsData.length === 10) {
                            const normalized = controlsData.map(tier => ({
                                ...tier,
                                controls: tier.controls.map(c => ({
                                    ...c,
                                    evidence: c.evidence || { notes: "", attachments: [] }
                                }))
                            }));
                            setData(normalized);
                            setIsMapLoaded(true);
                        }

                        // Load Assessment Meta if it exists
                        if (parsed.assessmentMeta) {
                            setAssessmentMeta(parsed.assessmentMeta);
                        }

                        // Load Type ID
                        if (parsed.assessmentTypeID) {
                            setSelectedTypeID(parsed.assessmentTypeID);
                        }

                        // Load Sort Config
                        if (parsed.sortConfig) {
                            setSortConfig(parsed.sortConfig);
                        }

                    } catch (e) {
                        console.error("Error loading data", e);
                    }
                }
                
                // Fetch assessment types
                fetch(ASSESSMENT_TYPES_URL)
                    .then(res => res.json())
                    .then(types => {
                        if (Array.isArray(types)) setAssessmentTypes(types);
                        else if (types.types) setAssessmentTypes(types.types);
                    })
                    .catch(err => console.error("Failed to load assessment types", err));
            }, []);

            // Save to LocalStorage on Change
            useEffect(() => {
                try {
                    const storageObj = {
                        data: data,
                        assessmentMeta: assessmentMeta,
                        assessmentTypeID: selectedTypeID,
                        sortConfig: sortConfig
                    };
                    localStorage.setItem('cis_assessment_data', JSON.stringify(storageObj));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        showNotify("Storage Quota Exceeded! Remove some large attachments.", true);
                    }
                }
            }, [data, assessmentMeta, selectedTypeID, sortConfig]);

            const updateAssessmentMeta = (field, value) => {
                setAssessmentMeta(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const handleTypeChange = async (e) => {
                const newTypeID = e.target.value;
                setSelectedTypeID(newTypeID);

                if (!newTypeID) return;

                setLoading(true);
                try {
                    const res = await fetch(RUBRIC_URL);
                    const rubrics = await res.json();
                    
                    // Update rubrics in data based on selected type
                    const updatedData = data.map(tier => ({
                        ...tier,
                        controls: tier.controls.map(control => {
                            // Find matching rubric entries for this control
                            const matchingRubricEntries = rubrics.filter(r => {
                                const rSafeguardID = (r.SafeguardID || "").toString().replace(/^SG/i, '');
                                const controlId = (control.id || "").toString().replace(/^SG/i, '');
                                const rTypeID = (r.TypeID || "").toString();
                                const targetTypeID = newTypeID.toString();
                                return rSafeguardID === controlId && rTypeID === targetTypeID;
                            });

                            if (matchingRubricEntries.length > 0) {
                                // Create a new levels object based on found entries
                                // We look for an entry where "Level" matches 1, 2, 3, or 4
                                const newLevels = { ...control.levels };
                                
                                matchingRubricEntries.forEach(entry => {
                                    // Extract the number from "Level 1", "Level 2", etc.
                                    const levelStr = entry.Level ? entry.Level.toString() : "";
                                    const match = levelStr.match(/(\d+)/);
                                    
                                    if (match) {
                                        const levelNum = parseInt(match[0]);
                                        if (levelNum >= 1 && levelNum <= 4) {
                                            newLevels[levelNum] = entry.Description;
                                        }
                                    }
                                });

                                return {
                                    ...control,
                                    levels: newLevels
                                };
                            }
                            return control;
                        })
                    }));
                    
                    setData(updatedData);
                    showNotify(`Rubrics loaded for Assessment Type ID: ${newTypeID}`);
                } catch (err) {
                    console.error("Failed to load rubrics", err);
                    showNotify("Failed to load rubrics for selected type", true);
                } finally {
                    setLoading(false);
                }
            };

            const updateControl = (tierIndex, controlIndex, updates) => {
                const newData = [...data];
                newData[tierIndex].controls[controlIndex] = {
                    ...newData[tierIndex].controls[controlIndex],
                    ...updates
                };
                setData(newData);
            };

            const downloadData = () => {
                const exportObj = {
                    assessmentTypeID: selectedTypeID,
                    timestamp: new Date().toISOString(),
                    assessmentMeta: assessmentMeta,
                    data: data,
                    sortConfig: sortConfig
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `cis_assessment_backup.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                showNotify("Assessment saved to file!");
            };

            const handleFileUpload = (event) => {
                const fileReader = new FileReader();
                fileReader.readAsText(event.target.files[0], "UTF-8");
                fileReader.onload = e => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        // Handle both old array format and new object format
                        let controlsData = Array.isArray(parsed) ? parsed : parsed.data;
                        
                        if (controlsData && controlsData.length > 0 && controlsData[0].controls) {
                            const normalized = controlsData.map(tier => ({
                                ...tier,
                                controls: tier.controls.map(c => ({
                                    ...c,
                                    evidence: c.evidence || { notes: "", attachments: [] }
                                }))
                            }));
                            setData(normalized);
                            if (parsed.assessmentTypeID) setSelectedTypeID(parsed.assessmentTypeID);
                            if (parsed.assessmentMeta) setAssessmentMeta(parsed.assessmentMeta);
                            if (parsed.sortConfig) setSortConfig(parsed.sortConfig);
                            
                            setIsMapLoaded(true);
                            showNotify("Assessment loaded successfully!");
                        } else {
                            showNotify("Invalid assessment backup file.", true);
                        }
                    } catch (err) {
                        showNotify("Error parsing file.", true);
                    }
                };
            };

            const processMappingData = (jsonInput) => {
                let items = [];
                if (Array.isArray(jsonInput)) {
                    items = jsonInput;
                } else if (jsonInput && typeof jsonInput === 'object') {
                    const key = Object.keys(jsonInput).find(k => Array.isArray(jsonInput[k]));
                    if (key) items = jsonInput[key];
                }

                if (!items.length) {
                    showNotify("JSON valid, but no array of controls found.", true);
                    return;
                }

                const newStructure = INITIAL_DATA.map(t => ({...t, controls: []}));
                let matchCount = 0;
                
                items.forEach(item => {
                    const getVal = (k) => item[Object.keys(item).find(key => key.toLowerCase() === k.toLowerCase())];
                    
                    let tierNum = getVal('TierNumber');
                    if (!tierNum) tierNum = getVal('tier');
                    
                    let rawId = getVal('ID'); 
                    if (!rawId) rawId = getVal('safeguard');

                    let title = getVal('Title') || getVal('name');
                    let description = getVal('Description') || getVal('desc') || getVal('Action Plan');
                    
                    if (tierNum && rawId) {
                        const tierInt = parseInt(tierNum);
                        const cleanId = rawId.toString().replace(/^SG/i, '');

                        if (!isNaN(tierInt) && tierInt >= 1 && tierInt <= 10) {
                            newStructure[tierInt - 1].controls.push({
                                id: cleanId,
                                title: title || "Title Unavailable",
                                actionPlan: description || "Description Unavailable",
                                levels: { 1: "Initial", 2: "Partial", 3: "Majority", 4: "Complete" },
                                selectedLevel: null,
                                evidence: { notes: "", attachments: [] }
                            });
                            matchCount++;
                        }
                    }
                });

                const totalControls = newStructure.reduce((acc, t) => acc + t.controls.length, 0);
                
                if (totalControls > 0) {
                    newStructure.forEach(t => {
                        t.controls.sort((a, b) => {
                            if (!a.id || !b.id) return 0;
                            const aParts = a.id.toString().split('.').map(Number);
                            const bParts = b.id.toString().split('.').map(Number);
                            if(aParts[0] !== bParts[0]) return aParts[0] - bParts[0];
                            return aParts[1] - bParts[1];
                        });
                    });
                    setData(newStructure);
                    setIsMapLoaded(true);
                    showNotify(`Successfully populated ${totalControls} controls!`);
                } else {
                    showNotify("No valid controls found (TierNumber 1-10 missing in JSON).", true);
                }
            };

            const handleUrlFetch = async () => {
                setLoading(true);
                try {
                    const response = await fetch(MAP_URL);
                    if (!response.ok) throw new Error("Network response was not ok");
                    const jsonMap = await response.json();
                    processMappingData(jsonMap);
                } catch (error) {
                    console.error("Fetch error:", error);
                    showNotify("Failed to fetch from GitHub. Please check network/URL.", true);
                } finally {
                    setLoading(false);
                }
            };

            const handleMappingUpload = (event) => {
                const fileReader = new FileReader();
                fileReader.readAsText(event.target.files[0], "UTF-8");
                fileReader.onload = e => {
                    try {
                        const jsonMap = JSON.parse(e.target.result);
                        processMappingData(jsonMap);
                    } catch (err) {
                        showNotify("Error parsing mapping file.", true);
                    }
                };
            };

            const showNotify = (msg, isError = false) => {
                setNotification({ msg, isError });
                setTimeout(() => setNotification(null), 3000);
            };

            // Calculate Aggregates
            const aggregates = useMemo(() => {
                let totalScore = 0;
                let totalMax = 0;
                let counts = { 1: 0, 2: 0, 3: 0, 4: 0, na: 0, unassigned: 0 };
                
                // Tier Ranking Logic
                let tierRank = 0;
                let sequenceBroken = false;

                data.forEach((tier, index) => {
                    const stats = calculateTierScore(tier);
                    totalScore += stats.score;
                    totalMax += tier.maxScore;
                    
                    tier.controls.forEach(c => {
                        if (c.selectedLevel === 'N/A') counts.na++;
                        else if (c.selectedLevel) counts[c.selectedLevel]++;
                        else counts.unassigned++;
                    });

                    // Check for Tier Ranking advancement
                    // Rule: All controls in this tier must be Level 4 or N/A
                    // AND all previous tiers must have been passed (handled by sequenceBroken)
                    if (!sequenceBroken) {
                        // Check if safeguards exist and are all valid (4 or N/A)
                        if (tier.controls && tier.controls.length > 0) {
                            const isTierComplete = tier.controls.every(c => c.selectedLevel == 4 || c.selectedLevel === 'N/A');
                            if (isTierComplete) {
                                tierRank = index + 1; // Promote to this Tier (index 0 is Tier 1)
                            } else {
                                sequenceBroken = true; // Stop advancing
                            }
                        } else {
                            // If a tier has no controls, we assume it's passed, but in this context 
                            // we usually expect controls. If empty, we allow advancement.
                            tierRank = index + 1;
                        }
                    }
                });

                return { totalScore, totalMax, counts, tierRank };
            }, [data]);

            // --- Main Render Switch ---
            const renderContent = () => {
                if (view === 'intro') return <IntroductionView setView={setView} />;
                if (view === 'info') return <AssessmentInfoView meta={assessmentMeta} updateMeta={updateAssessmentMeta} />;
                if (view === 'score') return <ScoreView aggregates={aggregates} data={data} setView={setView} />;
                if (view === 'summary') return <SummaryView data={data} downloadData={downloadData} sortConfig={sortConfig} setSortConfig={setSortConfig} />;
                if (view === 'about') return <AboutView />;
                if (view.startsWith('tier-')) return <TierView tierIndex={parseInt(view.split('-')[1])} data={data} updateControl={updateControl} showNotify={showNotify} setView={setView} />;
                return <IntroductionView setView={setView} />;
            };

            return (
                <div className="flex min-h-screen">
                    <Sidebar 
                        view={view} 
                        setView={setView} 
                        loading={loading}
                        handleUrlFetch={handleUrlFetch}
                        selectedTypeID={selectedTypeID}
                        handleTypeChange={handleTypeChange}
                        isMapLoaded={isMapLoaded}
                        assessmentTypes={assessmentTypes}
                        data={data}
                        downloadData={downloadData}
                        handleMappingUpload={handleMappingUpload}
                        handleFileUpload={handleFileUpload}
                    />
                    <main className="flex-1 ml-64 p-8 overflow-y-auto h-screen">
                        {renderContent()}
                    </main>
                    
                    {notification && (
                        <div className={`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium animate-bounce ${notification.isError ? 'bg-red-600' : 'bg-green-600'}`}>
                            {notification.msg}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>