<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCNE CIS Controls Assessment Tool</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- jsPDF & AutoTable for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f3f4f6; }
        .sidebar-item.active { background-color: #e0e7ff; color: #3730a3; border-right: 4px solid #3730a3; }
        .tier-card { transition: all 0.2s; }
        .tier-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        input[type="radio"]:checked + label {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        
        /* Loading Spinner */
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { jsPDF } = window.jspdf;

        // --- Inline Icons ---
        const IconWrapper = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Shield = ({ className }) => <IconWrapper className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" /></IconWrapper>;
        const LayoutDashboard = ({ className }) => <IconWrapper className={className}><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></IconWrapper>;
        const FileText = ({ className }) => <IconWrapper className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></IconWrapper>;
        const Settings = ({ className }) => <IconWrapper className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconWrapper>;
        const Upload = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></IconWrapper>;
        const Download = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></IconWrapper>;
        const ChevronRight = ({ className }) => <IconWrapper className={className}><path d="m9 18 6-6-6-6" /></IconWrapper>;
        const ChevronDown = ({ className }) => <IconWrapper className={className}><path d="m6 9 6 6 6-6" /></IconWrapper>;
        const ChevronUp = ({ className }) => <IconWrapper className={className}><path d="m18 15-6-6-6 6" /></IconWrapper>;
        const CheckCircle2 = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></IconWrapper>;
        const Info = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></IconWrapper>;
        const FileJson = ({ className }) => <IconWrapper className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><path d="M10 12a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1" /><path d="M14 12a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1" /></IconWrapper>;
        const Globe = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><line x1="2" x2="22" y1="12" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></IconWrapper>;
        const Paperclip = ({ className }) => <IconWrapper className={className}><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" /></IconWrapper>;
        const Image = ({ className }) => <IconWrapper className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></IconWrapper>;
        const Trash2 = ({ className }) => <IconWrapper className={className}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></IconWrapper>;
        const MessageSquare = ({ className }) => <IconWrapper className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></IconWrapper>;
        const BookOpen = ({ className }) => <IconWrapper className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></IconWrapper>;
        const ListChecks = ({ className }) => <IconWrapper className={className}><path d="M10 6h11" /><path d="M10 12h11" /><path d="M10 18h11" /><path d="M3 6h1" /><path d="M3 12h1" /><path d="M3 18h1" /></IconWrapper>;
        const MapPin = ({ className }) => <IconWrapper className={className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></IconWrapper>;
        const User = ({ className }) => <IconWrapper className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></IconWrapper>;
        const Calendar = ({ className }) => <IconWrapper className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></IconWrapper>;
        const Building = ({ className }) => <IconWrapper className={className}><rect x="4" y="2" width="16" height="20" rx="2" ry="2" /><line x1="9" y1="22" x2="9" y2="12" /><line x1="15" y1="12" x2="15" y2="22" /><line x1="4" y1="12" x2="20" y2="12" /><line x1="4" y1="7" x2="20" y2="7" /><line x1="4" y1="17" x2="20" y2="17" /></IconWrapper>;
        const HelpCircle = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" /></IconWrapper>;
        const Clock = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></IconWrapper>;

        // --- Helper Functions ---

        const generatePlaceholders = (startId, count, tierPrefix) => {
            return Array.from({ length: count }, (_, i) => ({
                id: `${tierPrefix}.${startId + i}`,
                title: `Safeguard ${tierPrefix}.${startId + i} (Placeholder)`,
                actionPlan: "Specific control details not yet loaded. Use 'Fetch Official Mapping' to populate this data.",
                levels: {
                    1: "Initial implementation details not available.",
                    2: "Partial implementation details not available.",
                    3: "Majority implementation details not available.",
                    4: "Complete implementation details not available."
                },
                selectedLevel: null,
                evidence: {
                    notes: "",
                    attachments: []
                },
                rubricDescription: null 
            }));
        };

        const calculateTierScore = (tier) => {
            let score = 0;
            let answered = 0;
            let nas = 0;
            
            tier.controls.forEach(c => {
                const val = c.selectedLevel;
                if (val === 'N/A') {
                    nas++;
                } else if (val) {
                    score += (parseInt(val) * 0.25);
                    answered++;
                }
            });
            return { score, answered, nas };
        };

        const calculateAggregates = (data) => {
            let totalScore = 0;
            let totalMax = 0;
            let counts = { 1: 0, 2: 0, 3: 0, 4: 0, na: 0, unassigned: 0 };
            let tierRank = 0;
            let sequenceBroken = false;

            data.forEach((tier, index) => {
                const stats = calculateTierScore(tier);
                totalScore += stats.score;
                totalMax += tier.maxScore;
                
                tier.controls.forEach(c => {
                    if (c.selectedLevel === 'N/A') counts.na++;
                    else if (c.selectedLevel) counts[c.selectedLevel]++;
                    else counts.unassigned++;
                });

                if (!sequenceBroken) {
                    if (tier.controls && tier.controls.length > 0) {
                        const isTierComplete = tier.controls.every(c => c.selectedLevel == 4 || c.selectedLevel === 'N/A');
                        if (isTierComplete) tierRank = index + 1;
                        else sequenceBroken = true;
                    } else {
                        tierRank = index + 1;
                    }
                }
            });

            return { totalScore, totalMax, counts, tierRank };
        };

        // Evidence helper to limit file size (500KB limit for browser storage safety)
        const FILE_SIZE_LIMIT = 500 * 1024;

        const INITIAL_DATA = [
            {
                id: 1, name: "Tier 1", description: "Foundational Controls (Subset of IG1)", maxScore: 15, controls: [
                    {
                        id: "1.1",
                        title: "Establish and Maintain Detailed Enterprise Asset Inventory",
                        actionPlan: "Establish and maintain an accurate, detailed, and up-to-date inventory of all enterprise assets with the potential to store or process data.",
                        levels: { 
                            1: "No comprehensive inventory of enterprise assets exists, including end-user devices, network devices, non-computing/IoT devices, and servers.", 
                            2: "An incomplete inventory is maintained, with some assets listed but lacking essential details such as hardware address or department ownership. Review and update process is not regularly conducted.", 
                            3: "Inventory exists but the update process is not regular or thorough. Some assets may be missing or details outdated.", 
                            4: "Comprehensive, up-to-date inventory exists and is reviewed bi-annually or more frequently. Records include network address, hardware address, machine name, owner, and department." 
                        },
                        selectedLevel: null,
                        evidence: { notes: "", attachments: [] },
                        rubricDescription: null
                    },
                    ...generatePlaceholders(2, 14, 1)
                ]
            },
            { id: 2, name: "Tier 2", description: "Foundational Controls (IG1/IG2)", maxScore: 11, controls: generatePlaceholders(1, 11, 2) },
            { id: 3, name: "Tier 3", description: "Foundational Controls", maxScore: 16, controls: generatePlaceholders(1, 16, 3) },
            { id: 4, name: "Tier 4", description: "Equivalent to IG1 Completion", maxScore: 15, controls: generatePlaceholders(1, 15, 4) },
            { id: 5, name: "Tier 5", description: "Mid-level Controls (IG2)", maxScore: 25, controls: generatePlaceholders(1, 25, 5) },
            { id: 6, name: "Tier 6", description: "Mid-level Controls (IG2)", maxScore: 25, controls: generatePlaceholders(1, 25, 6) },
            { id: 7, name: "Tier 7", description: "Equivalent to IG2 Completion", maxScore: 24, controls: generatePlaceholders(1, 24, 7) },
            { id: 8, name: "Tier 8", description: "Advanced Controls (IG3)", maxScore: 7, controls: generatePlaceholders(1, 7, 8) },
            { id: 9, name: "Tier 9", description: "Advanced Controls (IG3)", maxScore: 7, controls: generatePlaceholders(1, 7, 9) },
            { id: 10, name: "Tier 10", description: "Equivalent to IG3 Completion", maxScore: 8, controls: generatePlaceholders(1, 8, 10) }
        ];

        const MAP_URL = "https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/main/safeguards.json";
        const ASSESSMENT_TYPES_URL = "https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/main/assessmentType.json";
        const RUBRIC_URL = "https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/main/rubric.json";

        // --- PDF Generation Functions ---

        const generatePDFHeader = (doc, meta, title) => {
            const orgName = meta.orgName || "Organization Name";
            const dateStr = new Date().toLocaleDateString();
            
            doc.setFillColor(79, 70, 229); // Indigo 600
            doc.rect(0, 0, 210, 25, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.text(title, 14, 16);
            
            doc.setFontSize(10);
            doc.text(`${orgName} | ${dateStr}`, 196, 16, { align: 'right' });
            
            doc.setTextColor(0, 0, 0);
            return 35; // Returns Y start position for content
        };

        const generateCoverPage = (doc, meta, title) => {
            const pageWidth = doc.internal.pageSize.width;
            const margin = 14;
            let yPos = 20;

            // Header Background
            doc.setFillColor(79, 70, 229); // Indigo 600
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text(title, margin, 25);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, margin, 35);

            yPos = 55;
            doc.setTextColor(0, 0, 0);

            // Organization Info
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text("Organization Information", margin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Name: ${meta.orgName || 'N/A'}`, margin, yPos);
            yPos += 6;
            doc.text(`Address:`, margin, yPos);
            const addressLines = doc.splitTextToSize(meta.address || 'N/A', 100);
            doc.text(addressLines, margin + 20, yPos);
            yPos += (addressLines.length * 5) + 5;

            // Dates
            doc.text(`Start Date: ${meta.startDate || 'N/A'}`, margin, yPos);
            doc.text(`End Date: ${meta.endDate || 'In Progress'}`, margin + 80, yPos);
            yPos += 15;

            // Personnel Grid
            const col1 = margin;
            const col2 = margin + 90;

            // Authorizer
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("Authorizing Official", col1, yPos);
            doc.text("Point of Contact", col2, yPos);
            yPos += 6;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(meta.authorizer.name || '-', col1, yPos);
            doc.text(meta.poc.name || '-', col2, yPos);
            yPos += 5;
            doc.text(meta.authorizer.email || '-', col1, yPos);
            doc.text(meta.poc.email || '-', col2, yPos);
            yPos += 5;
            doc.text(meta.authorizer.phone || '-', col1, yPos);
            doc.text(meta.poc.phone || '-', col2, yPos);
            
            yPos += 15;

            // Assessor
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("Assessor Information", col1, yPos);
            yPos += 6;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Name: ${meta.assessor.name || '-'}`, col1, yPos);
            yPos += 5;
            doc.text(`Company: ${meta.assessor.company || '-'}`, col1, yPos);
            yPos += 5;
            doc.text(`Contact: ${meta.assessor.email || '-'} / ${meta.assessor.phone || '-'}`, col1, yPos);

            yPos += 15;

            // Notes
            if (meta.orgNotes) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text("Organization Notes", margin, yPos);
                yPos += 6;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const notes = doc.splitTextToSize(meta.orgNotes, pageWidth - (margin * 2));
                doc.text(notes, margin, yPos);
                yPos += (notes.length * 5) + 10;
            }

            if (meta.assessmentNotes) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text("Assessment Notes", margin, yPos);
                yPos += 6;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const notes = doc.splitTextToSize(meta.assessmentNotes, pageWidth - (margin * 2));
                doc.text(notes, margin, yPos);
            }

            // Page Break
            doc.addPage();
            
            // Return standard header Y start for subsequent pages
            return generatePDFHeader(doc, meta, title, true); 
        }

        const generateExecutiveReport = (data, meta, aggregates) => {
            const doc = new jsPDF();
            // Generate Cover Page first
            let yPos = generateCoverPage(doc, meta, "Executive Summary Report");

            // 1. High Level Stats
            doc.setFontSize(14);
            doc.text("Assessment Overview", 14, yPos);
            yPos += 10;

            const compliance = aggregates.totalMax > 0 ? ((aggregates.totalScore / aggregates.totalMax) * 100).toFixed(1) : 0;
            const stats = [
                { label: "Current Rank", value: `Tier ${aggregates.tierRank}` },
                { label: "Total Score", value: `${aggregates.totalScore.toFixed(2)} / ${aggregates.totalMax}` },
                { label: "Compliance", value: `${compliance}%` },
                { label: "Assessed", value: `${153 - aggregates.counts.unassigned} / 153` }
            ];

            let xPos = 14;
            stats.forEach(stat => {
                doc.setFillColor(243, 244, 246);
                doc.roundedRect(xPos, yPos, 40, 25, 2, 2, 'F');
                doc.setFontSize(8);
                doc.setTextColor(107, 114, 128);
                doc.text(stat.label, xPos + 20, yPos + 8, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(17, 24, 39);
                doc.setFont(undefined, 'bold');
                doc.text(stat.value, xPos + 20, yPos + 18, { align: 'center' });
                doc.setFont(undefined, 'normal');
                xPos += 45;
            });

            yPos += 35;

            // 2. Implementation Visual Chart
            doc.setFontSize(14);
            doc.text("Implementation Breakdown", 14, yPos);
            yPos += 10;

            // Draw Bar
            const totalWidth = 180;
            const h = 10;
            const c = aggregates.counts;
            const total = 153;
            
            const w4 = (c[4] / total) * totalWidth;
            const w3 = (c[3] / total) * totalWidth;
            const w2 = (c[2] / total) * totalWidth;
            const w1 = (c[1] / total) * totalWidth;
            // const wNa = (c.na / total) * totalWidth; // Not showing NA in bar usually, or make it gray
            
            let currentX = 14;
            
            // Level 4 - Green
            if(w4 > 0) { doc.setFillColor(34, 197, 94); doc.rect(currentX, yPos, w4, h, 'F'); currentX += w4; }
            // Level 3 - Blue
            if(w3 > 0) { doc.setFillColor(59, 130, 246); doc.rect(currentX, yPos, w3, h, 'F'); currentX += w3; }
            // Level 2 - Yellow
            if(w2 > 0) { doc.setFillColor(234, 179, 8); doc.rect(currentX, yPos, w2, h, 'F'); currentX += w2; }
            // Level 1 - Red
            if(w1 > 0) { doc.setFillColor(239, 68, 68); doc.rect(currentX, yPos, w1, h, 'F'); currentX += w1; }
            // Remainder - Gray
            if(currentX < (14 + totalWidth)) { doc.setFillColor(229, 231, 235); doc.rect(currentX, yPos, (14 + totalWidth) - currentX, h, 'F'); }

            yPos += 15;
            
            // Legend
            doc.setFontSize(9);
            const legendItems = [
                { color: [34, 197, 94], label: `Complete (${c[4]})` },
                { color: [59, 130, 246], label: `Majority (${c[3]})` },
                { color: [234, 179, 8], label: `Partial (${c[2]})` },
                { color: [239, 68, 68], label: `Initial (${c[1]})` },
                { color: [229, 231, 235], label: `Unscored/NA (${c.unassigned + c.na})` }
            ];
            
            let legX = 14;
            legendItems.forEach(item => {
                doc.setFillColor(...item.color);
                doc.circle(legX, yPos, 1.5, 'F');
                doc.setTextColor(50, 50, 50);
                doc.text(item.label, legX + 4, yPos + 1);
                legX += 35;
            });

            yPos += 20;

            // 3. Tier Table
            doc.setFontSize(14);
            doc.setTextColor(0,0,0);
            doc.text("Tier Progress Summary", 14, yPos);
            yPos += 5;

            const tableBody = data.map(tier => {
                const s = calculateTierScore(tier);
                const pct = ((s.score / tier.maxScore) * 100).toFixed(0) + '%';
                return [tier.name, tier.description, pct, s.score.toFixed(2), tier.maxScore];
            });

            doc.autoTable({
                startY: yPos,
                head: [['Tier', 'Description', 'Progress', 'Score', 'Max']],
                body: tableBody,
                headStyles: { fillColor: [79, 70, 229] },
                theme: 'striped'
            });

            doc.save(`Executive_Report_${meta.orgName.replace(/\s+/g, '_')}.pdf`);
        };

        const generateDetailedReport = (data, meta, aggregates) => {
            const doc = new jsPDF();
            // Generate Cover Page first
            let yPos = generateCoverPage(doc, meta, "Detailed Assessment Report");

            // Executive summary info at top
            doc.setFontSize(10);
            doc.text(`Total Score: ${aggregates.totalScore.toFixed(2)} / ${aggregates.totalMax}`, 14, yPos);
            doc.text(`Controls Assessed: ${153 - aggregates.counts.unassigned} / 153`, 100, yPos);
            yPos += 10;

            // Flatten data
            let rows = [];
            data.forEach(tier => {
                // Tier Header Row (simulated by a row with colSpan logic in autotable or just distinct rows)
                // AutoTable doesn't support easy mid-table headers well without specific hooks, 
                // so we will add a row that looks like a header.
                rows.push({
                    id: tier.name,
                    title: tier.description, 
                    level: '',
                    evidence: '',
                    isTierHeader: true
                });

                tier.controls.forEach(c => {
                    let levelText = "Unscored";
                    if (c.selectedLevel === 'N/A') levelText = "N/A";
                    else if (c.selectedLevel) levelText = `Level ${c.selectedLevel}`;

                    // Prepare Evidence Text
                    let evidenceText = c.evidence.notes || "";
                    let hasAttachments = c.evidence.attachments && c.evidence.attachments.length > 0;
                    
                    rows.push({
                        id: c.id,
                        title: c.title,
                        level: levelText,
                        evidence: evidenceText, // Text part
                        attachments: c.evidence.attachments || [],
                        isTierHeader: false
                    });
                });
            });

            doc.autoTable({
                startY: yPos,
                head: [['ID', 'Control Title', 'Level', 'Evidence & Notes']],
                body: rows.map(r => {
                    if (r.isTierHeader) return [r.id.toUpperCase(), r.title, '', ''];
                    return [r.id, r.title, r.level, r.evidence];
                }),
                didParseCell: function(data) {
                    const row = rows[data.row.index];
                    if (row && row.isTierHeader) {
                        data.cell.styles.fillColor = [224, 231, 255]; // Light Indigo
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [0, 0, 0];
                        if (data.column.index === 0) {
                            data.cell.colSpan = 4;
                        }
                    }
                },
                didDrawCell: function(data) {
                    // Check for images in Evidence column (index 3)
                    if (data.column.index === 3 && data.cell.section === 'body') {
                        const row = rows[data.row.index];
                        if (row && !row.isTierHeader && row.attachments && row.attachments.length > 0) {
                            let imgX = data.cell.x + 2;
                            let imgY = data.cell.y + data.cell.height - (row.attachments.length * 8) - 2; 
                            
                            // If there is text, the image needs to go after it. 
                            // AutoTable calculates height based on text. We might need to handle this manually 
                            // but drawing over text is bad.
                            // Strategy: Draw text normally (auto), then images.
                            
                            // Actually, let's just draw filenames and small thumbnails below text
                            // We rely on cell padding/height. 
                        }
                    }
                },
                // Custom Cell Content for attachments
                bodyStyles: { minCellHeight: 15 },
                columnStyles: {
                    0: { cellWidth: 25 }, // ID
                    1: { cellWidth: 60 }, // Title
                    2: { cellWidth: 25 }, // Level
                    3: { cellWidth: 'auto' } // Evidence
                },
                willDrawCell: function(data) {
                    if (data.column.index === 3 && data.cell.section === 'body') {
                         const row = rows[data.row.index];
                         if(row && !row.isTierHeader && row.attachments && row.attachments.length > 0) {
                             // Extend the text to include file names so auto-table calculates height
                             let fileNames = row.attachments.map(a => `[File] ${a.name}`).join('\n');
                             // We don't want to actually print this text if we draw thumbnails, but for "File" types we do.
                             // For now, let's append file info to the text content in data.cell.text
                             // Note: data.cell.text is an array of strings
                             
                             // This is tricky inside the hook. 
                             // Better strategy: Pre-process the body text before passing to autoTable
                         }
                    }
                },
                didDrawCell: (data) => {
                     if (data.column.index === 3 && data.cell.section === 'body') {
                        const row = rows[data.row.index];
                        if(row && !row.isTierHeader && row.attachments && row.attachments.length > 0) {
                            let cursorY = data.cell.y + 2;
                            // Move cursor past text
                            const textHeight = doc.getTextDimensions(data.cell.text).h; 
                            // approximate text usage. 
                            
                            // We will draw attachments at the bottom of the cell
                            // Autotable doesn't easily expand for images drawn manually.
                            // Simplified approach: Draw thumbnails in the right margin of the cell or below if space?
                            // Best approach for this constraints: 
                            // Iterate attachments. If image -> draw thumbnail. If file -> text.
                            
                            let attY = data.cell.y + data.cell.height - 10;
                            let attX = data.cell.x + 2;

                            row.attachments.forEach(att => {
                                if (att.type === 'image') {
                                    try {
                                        // Draw Thumbnail (8x8mm)
                                        doc.addImage(att.data, 'JPEG', attX, attY, 8, 8);
                                        attX += 10;
                                    } catch(e) { /* ignore invalid image data */ }
                                } 
                            });
                        }
                     }
                }
            });
            
            // To ensure space for images, we need to pre-process the text passed to autotable
            // Re-map rows logic slightly to include newlines for attachment space
            const processedBody = rows.map(r => {
                if(r.isTierHeader) return [r.id.toUpperCase(), r.title, '', ''];
                
                let text = r.evidence;
                let filesText = "";
                
                if(r.attachments && r.attachments.length > 0) {
                    // Add newlines to make space for thumbnails at bottom
                    // text += "\n\n\n"; 
                    
                    r.attachments.forEach(att => {
                        if(att.type !== 'image') {
                            filesText += `\nðŸ“Ž ${att.name}`;
                        } else {
                            // Just add spacing for image
                            text += "\n\n\n"; 
                        }
                    });
                }
                return [r.id, r.title, r.level, text + filesText];
            });
            
            // Rerun with processed body for correct spacing
            doc.lastAutoTable.finalY = yPos; // reset
             doc.autoTable({
                startY: yPos,
                head: [['ID', 'Control Title', 'Level', 'Evidence & Notes']],
                body: processedBody,
                didParseCell: function(data) {
                    const row = rows[data.row.index];
                    if (row && row.isTierHeader) {
                        data.cell.styles.fillColor = [224, 231, 255]; 
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [0, 0, 0];
                        if (data.column.index === 0) { data.cell.colSpan = 4; }
                    }
                },
                didDrawCell: function(data) {
                    if (data.column.index === 3 && data.cell.section === 'body') {
                        const row = rows[data.row.index];
                        if (row && !row.isTierHeader && row.attachments) {
                            const images = row.attachments.filter(a => a.type === 'image');
                            if(images.length > 0) {
                                let imgX = data.cell.x + 2;
                                // Draw at bottom of cell
                                let imgY = data.cell.y + data.cell.height - 12; 
                                
                                images.forEach(img => {
                                    try {
                                        doc.addImage(img.data, 'JPEG', imgX, imgY, 10, 10);
                                        doc.setDrawColor(200);
                                        doc.rect(imgX, imgY, 10, 10); // border
                                        imgX += 12;
                                    } catch(e){}
                                });
                            }
                        }
                    }
                },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 70 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 'auto' }
                },
                styles: { overflow: 'linebreak', cellPadding: 3 }
            });

            doc.save(`Detailed_Report_${meta.orgName.replace(/\s+/g, '_')}.pdf`);
        };


        // --- Components ---

        const EvidenceSection = ({ evidence = { notes: "", attachments: [] }, onChange, showNotify }) => {
            const fileInputRef = useRef(null);
            const imageInputRef = useRef(null);

            const handleFileRead = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > FILE_SIZE_LIMIT) {
                    showNotify("File too large. Max size is 500KB to ensure data saves correctly.", true);
                    e.target.value = "";
                    return;
                }

                const reader = new FileReader();
                reader.onload = (ev) => {
                    const newAttachment = {
                        id: Date.now(),
                        name: file.name,
                        type: type === 'image' ? 'image' : 'file',
                        data: ev.target.result
                    };
                    const updatedAttachments = [...(evidence.attachments || []), newAttachment];
                    onChange({ ...evidence, attachments: updatedAttachments });
                };
                reader.readAsDataURL(file);
                e.target.value = ""; 
            };

            const removeAttachment = (id) => {
                const updatedAttachments = evidence.attachments.filter(a => a.id !== id);
                onChange({ ...evidence, attachments: updatedAttachments });
            };

            return (
                <div className="mt-6 bg-gray-50 rounded-lg p-4 border border-gray-200 animate-fade-in">
                    <h4 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <Paperclip className="w-4 h-4" /> Evidence & Documentation
                    </h4>
                    <div className="mb-4">
                        <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">Notes / Comments</label>
                        <textarea 
                            className="w-full p-2 border rounded-md text-sm focus:ring-2 focus:ring-indigo-500 outline-none" 
                            rows="2"
                            placeholder="Add implementation details, gaps, or justification..."
                            value={evidence.notes || ""}
                            onChange={(e) => onChange({ ...evidence, notes: e.target.value })}
                        ></textarea>
                    </div>
                    <div className="flex gap-3 mb-4">
                        <button onClick={() => imageInputRef.current.click()} className="flex items-center gap-2 px-3 py-1.5 bg-white border rounded text-xs text-gray-700 hover:bg-gray-50">
                            <Image className="w-3 h-3" /> Add Picture
                        </button>
                        <input type="file" accept="image/*" ref={imageInputRef} className="hidden" onChange={(e) => handleFileRead(e, 'image')} />
                        <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-3 py-1.5 bg-white border rounded text-xs text-gray-700 hover:bg-gray-50">
                            <FileText className="w-3 h-3" /> Attach File
                        </button>
                         <input type="file" ref={fileInputRef} className="hidden" onChange={(e) => handleFileRead(e, 'file')} />
                    </div>
                    {evidence.attachments && evidence.attachments.length > 0 && (
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            {evidence.attachments.map(att => (
                                <div key={att.id} className="flex items-center justify-between p-2 bg-white border rounded shadow-sm text-sm">
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        {att.type === 'image' ? (
                                            <img src={att.data} alt="preview" className="w-8 h-8 object-cover rounded bg-gray-100" />
                                        ) : (
                                            <div className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded text-gray-500"><FileText className="w-4 h-4" /></div>
                                        )}
                                        <span className="truncate max-w-[150px]" title={att.name}>{att.name}</span>
                                    </div>
                                    <button onClick={() => removeAttachment(att.id)} className="text-red-400 hover:text-red-600 p-1"><Trash2 className="w-4 h-4" /></button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const ControlCard = ({ control, tierIndex, cIdx, updateControl, showNotify }) => {
            const [isRubricOpen, setIsRubricOpen] = useState(false);

            return (
                <div className="bg-white rounded-xl shadow-sm border overflow-hidden p-6 transition-all hover:shadow-md">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <span className="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded font-bold mb-2">Safeguard {control.id}</span>
                            <h3 className="text-lg font-bold text-gray-900">{control.title}</h3>
                        </div>
                    </div>
                    
                    <div className="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-100">
                        <div className="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 flex items-center gap-2">
                            <Settings className="w-4 h-4" /> Description
                        </div>
                        <p className="text-gray-600 text-sm leading-relaxed mb-3">{control.actionPlan}</p>
                        
                        <button 
                            onClick={() => setIsRubricOpen(!isRubricOpen)}
                            className="text-xs flex items-center gap-1 text-indigo-600 hover:text-indigo-800 font-medium transition-colors"
                        >
                            <BookOpen className="w-3 h-3" /> 
                            {isRubricOpen ? "Hide Rubric Description" : "Rubric Description"}
                            <ChevronDown className={`w-3 h-3 transition-transform ${isRubricOpen ? 'rotate-180' : ''}`} />
                        </button>

                        {isRubricOpen && (
                            <div className="mt-4 grid grid-cols-1 gap-3 pt-3 border-t border-gray-200 animate-fade-in">
                                <div className="text-xs">
                                    <span className="font-bold text-red-600 block mb-1">Level 1 (Initial)</span>
                                    <span className="text-gray-600">{control.levels[1]}</span>
                                </div>
                                <div className="text-xs">
                                    <span className="font-bold text-yellow-600 block mb-1">Level 2 (Partial)</span>
                                    <span className="text-gray-600">{control.levels[2]}</span>
                                </div>
                                <div className="text-xs">
                                    <span className="font-bold text-blue-600 block mb-1">Level 3 (Majority)</span>
                                    <span className="text-gray-600">{control.levels[3]}</span>
                                </div>
                                <div className="text-xs">
                                    <span className="font-bold text-green-600 block mb-1">Level 4 (Complete)</span>
                                    <span className="text-gray-600">{control.levels[4]}</span>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="space-y-3">
                        <div className="text-xs font-semibold text-gray-400 uppercase">Self Score</div>
                        <div className="grid grid-cols-1 sm:grid-cols-5 gap-3">
                            {[1, 2, 3, 4, 'N/A'].map((level) => {
                                const val = level === 'N/A' ? 'N/A' : level;
                                const isSelected = control.selectedLevel == val;
                                let label = level === 'N/A' ? 'N/A' : `Level ${level}`;
                                let points = level === 'N/A' ? '' : `(${level * 0.25} pts)`;
                                let activeClass = "";
                                if (isSelected) {
                                    if(level === 1) activeClass = "bg-red-500 border-red-500 text-white";
                                    else if(level === 2) activeClass = "bg-orange-500 border-orange-500 text-white";
                                    else if(level === 3) activeClass = "bg-blue-500 border-blue-500 text-white";
                                    else if(level === 4) activeClass = "bg-green-500 border-green-500 text-white";
                                    else activeClass = "bg-gray-500 border-gray-500 text-white";
                                } else {
                                    activeClass = "bg-white text-gray-600 hover:border-indigo-300";
                                }

                                return (
                                    <button
                                        key={level}
                                        onClick={() => updateControl(tierIndex, cIdx, { selectedLevel: val })}
                                        className={`flex flex-col items-center justify-center p-3 rounded-lg border transition-all ${activeClass}`}
                                    >
                                        <span className="font-bold">{label}</span>
                                        <span className="text-xs opacity-80">{points}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {control.selectedLevel && control.selectedLevel !== 'N/A' && (
                        <div className="mt-4 pt-4 border-t text-sm text-gray-600 animate-fade-in">
                            <span className="font-semibold text-gray-800">Current Level Definition:</span> {control.levels[control.selectedLevel]}
                        </div>
                    )}

                    {control.selectedLevel && (
                        <EvidenceSection 
                            evidence={control.evidence || { notes: "", attachments: [] }}
                            onChange={(newEvidence) => updateControl(tierIndex, cIdx, { evidence: newEvidence })}
                            showNotify={showNotify}
                        />
                    )}
                </div>
            );
        };

        const Sidebar = ({ view, setView, loading, handleUrlFetch, selectedTypeID, handleTypeChange, isMapLoaded, assessmentTypes, data, downloadData, handleMappingUpload, handleFileUpload }) => {
            const areTiersDisabled = !isMapLoaded || !selectedTypeID;

            return (
                <div className="w-64 bg-white border-r h-screen fixed overflow-y-auto flex flex-col shadow-lg z-10">
                    <div className="p-6 border-b flex items-center gap-3">
                        <Shield className="w-8 h-8 text-indigo-600" />
                        <div>
                            <h1 className="font-bold text-gray-800">NCNE / CIS</h1>
                            <p className="text-xs text-gray-500">Assessment Tool</p>
                        </div>
                    </div>
                    <nav className="flex-1 p-4 flex flex-col space-y-1">
                        
                        <div className="px-4 pb-4">
                            <button onClick={handleUrlFetch} disabled={loading} className="w-full flex items-center justify-center p-2 bg-indigo-600 border border-indigo-700 rounded text-xs text-white hover:bg-indigo-700 transition gap-2 shadow-sm">
                                {loading ? <div className="spinner"></div> : <Globe className="w-4 h-4" />}
                                Fetch Official Mapping
                            </button>
                        </div>

                        <div className="px-4 pb-4">
                            <label className="block text-xs font-medium text-gray-500 mb-1">Assessment Type</label>
                            <select 
                                value={selectedTypeID} 
                                onChange={handleTypeChange}
                                disabled={!isMapLoaded}
                                className={`w-full p-2 bg-white border rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none ${!isMapLoaded ? 'opacity-50 cursor-not-allowed bg-gray-100' : ''}`}
                            >
                                <option value="">Select Type...</option>
                                {assessmentTypes.map((type, i) => (
                                    <option key={i} value={type.TypeID}>{type.Type}</option>
                                ))}
                            </select>
                        </div>

                        <button onClick={() => setView('intro')} className={`sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'intro' ? 'active' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <Info className="w-4 h-4" /> Introduction
                        </button>

                        <button onClick={() => setView('info')} className={`sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'info' ? 'active' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <Building className="w-4 h-4" /> Assessment Information
                        </button>
                        
                        <button 
                            onClick={() => !areTiersDisabled && setView('score')} 
                            disabled={areTiersDisabled}
                            className={`sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'score' ? 'active' : ''} ${areTiersDisabled ? 'opacity-50 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-50'}`}
                        >
                            <LayoutDashboard className="w-4 h-4" /> Score & Dashboard
                        </button>

                        <div className="pt-4 pb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider px-4">Tiers</div>
                        {data.map((tier, idx) => {
                            const total = tier.controls.length;
                            const entered = tier.controls.filter(c => c.selectedLevel).length; // Includes 'N/A' if selectedLevel is set to it
                            const isComplete = total > 0 && entered === total;
                            const isPartial = entered > 0 && entered < total;
                            
                            return (
                                <button 
                                    key={tier.id} 
                                    onClick={() => !areTiersDisabled && setView(`tier-${idx}`)} 
                                    disabled={areTiersDisabled}
                                    className={`sidebar-item w-full flex items-center justify-between px-4 py-2.5 rounded-lg text-sm font-medium ${view === `tier-${idx}` ? 'active' : ''} ${areTiersDisabled ? 'opacity-50 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-50'}`}
                                >
                                    <span className="flex items-center gap-2">
                                        <span className="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">{tier.id}</span>
                                        {tier.name}
                                    </span>
                                    {isComplete && <CheckCircle2 className="w-4 h-4 text-green-500"/>}
                                    {isPartial && <Clock className="w-4 h-4 text-orange-400"/>}
                                </button>
                            );
                        })}
                        <button onClick={() => setView('summary')} className={`sidebar-item mt-4 w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'summary' ? 'active' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <FileText className="w-4 h-4" /> Full Summary
                        </button>

                        <button onClick={() => setView('about')} className={`sidebar-item mt-auto w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium ${view === 'about' ? 'active' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <HelpCircle className="w-4 h-4" /> About
                        </button>
                    </nav>
                    <div className="p-4 border-t bg-gray-50">
                        <div className="space-y-2">
                            <label className="flex items-center justify-center p-2 bg-indigo-50 border border-indigo-200 rounded text-xs text-indigo-700 hover:bg-indigo-100 transition cursor-pointer gap-2">
                                <FileJson className="w-4 h-4" /> Upload Map File
                                <input type="file" className="hidden" accept=".json" onChange={handleMappingUpload}/>
                            </label>

                            <div className="grid grid-cols-2 gap-2 mt-2">
                                <button onClick={downloadData} className="flex flex-col items-center justify-center p-2 bg-white border rounded text-xs text-gray-600 hover:bg-gray-50 transition">
                                    <Download className="w-4 h-4 mb-1" /> Backup
                                </button>
                                <label className="flex flex-col items-center justify-center p-2 bg-white border rounded text-xs text-gray-600 hover:bg-gray-50 transition cursor-pointer">
                                    <Upload className="w-4 h-4 mb-1" /> Load
                                    <input type="file" className="hidden" accept=".json" onChange={handleFileUpload}/>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AboutView = () => {
            return (
                <div className="max-w-4xl mx-auto space-y-6">
                    <div className="bg-white p-8 rounded-xl shadow-sm border">
                        <h2 className="text-2xl font-bold text-gray-900 mb-8 text-center">About the CIS Cybersecurity Assessment Tool</h2>
                        
                        {/* Logos */}
                        <div className="flex justify-center gap-8 mb-10">
                            <div className="w-32 h-32 bg-gray-50 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-200 p-2">
                                <img src="https://raw.githubusercontent.com/MidwestCyberLLC/CIS-Tool-Mapping/refs/heads/main/images/NCNELogo.png" alt="Organization Logo 1" className="max-w-full max-h-full object-contain" />
                            </div>
                            <div className="w-32 h-32 bg-gray-50 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-200 p-2">
                                <img src="https://github.com/MidwestCyberLLC/CIS-Tool-Mapping/blob/main/images/CISLogo.png?raw=true" alt="Organization Logo 2" className="max-w-full max-h-full object-contain" />
                            </div>
                            <div className="w-32 h-32 bg-gray-50 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-200 p-2">
                                <img src="https://github.com/MidwestCyberLLC/CIS-Tool-Mapping/blob/main/images/MidwestCyberLogo.png?raw=true" alt="Organization Logo 3" className="max-w-full max-h-full object-contain" />
                            </div>
                        </div>

                        <div className="prose max-w-none text-gray-600 space-y-6">
                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-2">History</h3>
                                <p className="leading-relaxed">
                                    The CIS Cybersecurity Assessment Tool was developed by the Nebraska Cybersecurity Network for Education (NCNE), which was made possible by the State and Local Cybersecurity Grant Program. The tool is designed to help organizations assess their cybersecurity posture based on the CIS Critical Security Controls framework, providing a structured approach to identifying strengths and areas for improvement.  When the NCNE's grant came to an end, Midwest Cyber, LLC took over maintenance and development of the tool to ensure its continued availability and improvement for the community.
                                </p>
                            </div>
                            
                            <hr className="border-gray-100" />

                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-2">Support & Contact</h3>
                                <p className="leading-relaxed">
                                    In the short term, the CIS Cybersecurity Assessment Tool is being provided to the community free of charge but with no guarantee of support.  However, Midwest Cyber, LLC is exploring options for long-term sustainability, which may include premium features or support services in the future.  For any questions, support requests, or feedback regarding the tool, please contact Midwest Cyber, LLC at <a href="mailto:cistool@midwestcyber.net?subject=CIS Cybersecurity Assessment Tool">cistool@midwestcyber.net</a>
                                </p>
                            </div>

                            <hr className="border-gray-100" />
                            
                            <div className="flex justify-between items-end pt-4 text-sm text-gray-400">
                                <div>
                                    <p>Tool Version: 1.0.5</p>
                                    <p>Last Updated: November 2025</p>
                                </div>
                                <div className="text-right">
                                    <p>&copy; 2025 NCNE / CIS Assessment Tool</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const IntroductionView = ({ setView }) => {
            return (
                <div className="w-[75%] mx-auto space-y-6">
                    <div className="bg-white p-8 rounded-xl shadow-sm border">
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">Welcome to the CIS Controls Assessment</h2>
                        <div className="prose text-gray-600 space-y-4">
                            <p>The CIS Critical Security Controls (CIS Controls) are a prioritized set of Safeguards to mitigate the most prevalent cyber attacks against systems and networks. They are mapped to and referenced by multiple legal, regulatory, and policy frameworks.  Given the number of publicly available cybersecurity frameworks, the Nebraska Cybersecurity Network for Education (NCNE) is currently recommending schools and small organizations use an adapted variation of the CIS Controls.  These adaptations are outlined in this document.</p>
                            <p>The CIS Controls is natively broken into 3 sets of controls, known as Implementation Group 1 (IG1) with 57 total controls, Implementation Group 2 (IG2) with 131 total controls and Implementation Group 3 (IG3) with all 153 controls. The controls are logically grouped with the more foundational, and arguably easier, controls to implement are positioned in IG1.  IG2 adds more mid-level controls, and IG3 adds the final set of more difficult controls.</p>
                            
                            <h3 className="text-lg font-semibold text-gray-800 pt-2">How it works</h3>
                            <p>The NCNE adaptation of the CIS Controls is merely to further segment the controls within IG1, IG2 and IG3 into smaller groups, called tiers.  There are a total of 10 tiers, organized so that Tier 4 is the equivalent of IG1, Tier 7 is the equivalent of IG2 and Tier 10 is the equivalent of IG3.  The controls contained in each Tier are designed to be grouped so that implementation of each control is more similar than different.</p>
                            <p>On the Score tab will be a summary of the calculated scores from each of the Tiers.  Multiple score calculations will be provided to help to paint a picture of level and quality of the controls implemented.  Each control is scored on a 4-level grading system.  Points are awarded based on the level identified, with:
                            <br />
                            </p>
                            <ul className="list-disc pl-5 ml-4">
                                <li>0.25 points for Level 1</li>
                                <li>0.50 points for Level 2</li>
                                <li>0.75 points for Level 3</li>
                                <li>1.00 points for Level 4</li>
                            </ul>
                            <p> Controls marked as Not Applicable (N/A) do not contribute to the score, but are tracked separately to provide context on the total number of controls assessed.  Each Tier will also provide a breakdown of the number of controls at each level, as well as those marked N/A or unassigned.</p>
                            <p>The goal of this score is to be a snapshot in time.  It should provide guidance on what controls should be implemented, roughly in which order, and details on how to implement each control.  Reassessing your organization at a later time in the future should easily be able to show the positive progress you are taking to make your organization more secure.</p>
                            
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 my-4 text-sm text-blue-800 flex items-start gap-3">
                                <Globe className="w-5 h-5 mt-0.5 flex-shrink-0" />
                                <div>
                                    <strong>Latest Framework Data:</strong> Click the <span className="font-bold text-indigo-700">Fetch Official Mapping</span> button in the sidebar to automatically download and populate the latest Controls, Titles, and Descriptions directly from the MidwestCyberLLC GitHub repository.
                                </div>
                            </div>

                            <div className="bg-green-50 p-4 rounded-lg border border-green-100 my-4 text-sm text-green-800 flex items-start gap-3">
                                <ListChecks className="w-5 h-5 mt-0.5 flex-shrink-0" />
                                <div>
                                    <strong>Custom Rubrics:</strong> Select your <span className="font-bold">Assessment Type</span> from the sidebar dropdown to load specific grading criteria for each control level.
                                </div>
                            </div>

                            <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100 my-4">
                                <h4 className="font-semibold text-indigo-900 mb-2">Scoring System</h4>
                                <ul className="space-y-2 text-sm text-indigo-800">
                                    <li className="flex items-center gap-2"><span className="font-bold bg-white px-2 py-0.5 rounded border border-indigo-200">Level 1</span> Initial (0.25 points)</li>
                                    <li className="flex items-center gap-2"><span className="font-bold bg-white px-2 py-0.5 rounded border border-indigo-200">Level 2</span> Partial (0.50 points)</li>
                                    <li className="flex items-center gap-2"><span className="font-bold bg-white px-2 py-0.5 rounded border border-indigo-200">Level 3</span> Majority (0.75 points)</li>
                                    <li className="flex items-center gap-2"><span className="font-bold bg-white px-2 py-0.5 rounded border border-indigo-200">Level 4</span> Complete (1.00 points)</li>
                                </ul>
                            </div>
                            
                            <div className="mt-8 border-t pt-6">
                                <h3 className="text-lg font-bold text-gray-900 mb-4">Getting Started</h3>
                                <div className="space-y-4">
                                    <div className="flex gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                        <div className="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">1</div>
                                        <div>
                                            <h4 className="font-semibold text-gray-900">Load Framework Data</h4>
                                            <p className="text-sm text-gray-600">Click <span className="font-medium text-indigo-600">Fetch Official Mapping</span> in the sidebar (top left) to download the latest controls, or use the "Upload Map File" option at the bottom if you have a custom map.</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                        <div className="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">2</div>
                                        <div>
                                            <h4 className="font-semibold text-gray-900">Select Assessment Type</h4>
                                            <p className="text-sm text-gray-600">Choose your organization's specific assessment type from the dropdown menu in the sidebar to ensure the correct grading rubrics are loaded.</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                        <div className="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">3</div>
                                        <div>
                                            <h4 className="font-semibold text-gray-900">Begin Assessment</h4>
                                            <p className="text-sm text-gray-600">Navigate to <strong>Tier 1</strong> in the sidebar menu to start evaluating your safeguards. Proceed through the tiers sequentially.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ScoreView = ({ aggregates, data, setView }) => {
            return (
                <div className="max-w-6xl mx-auto space-y-6">
                    {/* Top Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-purple-100 relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-10">
                                <Shield className="w-16 h-16 text-purple-600" />
                            </div>
                            <div className="text-sm text-gray-500 font-medium">Current Rank</div>
                            <div className="text-3xl font-bold text-purple-600 mt-2">Tier {aggregates.tierRank}</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <div className="text-sm text-gray-500 font-medium">Total Score</div>
                            <div className="text-3xl font-bold text-indigo-600 mt-2">{aggregates.totalScore.toFixed(2)} <span className="text-gray-400 text-lg">/ {aggregates.totalMax}</span></div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <div className="text-sm text-gray-500 font-medium">Compliance</div>
                            <div className="text-3xl font-bold text-green-600 mt-2">{aggregates.totalMax > 0 ? ((aggregates.totalScore / aggregates.totalMax) * 100).toFixed(1) : 0}%</div>
                        </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <div className="text-sm text-gray-500 font-medium">Controls Assessed</div>
                            <div className="text-3xl font-bold text-blue-600 mt-2">{153 - aggregates.counts.unassigned} <span className="text-gray-400 text-lg">/ 153</span></div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <div className="text-sm text-gray-500 font-medium">Not Applicable</div>
                            <div className="text-3xl font-bold text-gray-600 mt-2">{aggregates.counts.na}</div>
                        </div>
                    </div>

                    {/* Breakdown Chart */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border">
                        <h3 className="font-bold text-gray-800 mb-4">Implementation Levels</h3>
                        <div className="flex h-6 rounded-full overflow-hidden bg-gray-100">
                            <div style={{width: `${(aggregates.counts[4]/153)*100}%`}} className="bg-green-500" title="Complete"></div>
                            <div style={{width: `${(aggregates.counts[3]/153)*100}%`}} className="bg-blue-500" title="Majority"></div>
                            <div style={{width: `${(aggregates.counts[2]/153)*100}%`}} className="bg-yellow-500" title="Partial"></div>
                            <div style={{width: `${(aggregates.counts[1]/153)*100}%`}} className="bg-red-500" title="Initial"></div>
                        </div>
                        <div className="flex justify-between mt-4 text-sm text-gray-600">
                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-green-500"></div> Complete ({aggregates.counts[4]})</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-blue-500"></div> Majority ({aggregates.counts[3]})</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-yellow-500"></div> Partial ({aggregates.counts[2]})</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-red-500"></div> Initial ({aggregates.counts[1]})</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-gray-200"></div> Unscored ({aggregates.counts.unassigned})</div>
                        </div>
                    </div>

                    {/* Detailed Tier Table */}
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-gray-50 border-b text-sm text-gray-500">
                                    <th className="px-6 py-4 font-semibold">Tier</th>
                                    <th className="px-6 py-4 font-semibold">Progress</th>
                                    <th className="px-6 py-4 font-semibold">Score</th>
                                    <th className="px-6 py-4 font-semibold text-right">Max</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.map((tier, i) => {
                                    const stats = calculateTierScore(tier);
                                    const percent = (stats.score / tier.maxScore) * 100;
                                    return (
                                        <tr key={tier.id} onClick={() => setView(`tier-${i}`)} className="border-b last:border-0 hover:bg-gray-50 cursor-pointer transition">
                                            <td className="px-6 py-4">
                                                <div className="font-semibold text-gray-900">{tier.name}</div>
                                                <div className="text-xs text-gray-500">{tier.description}</div>
                                            </td>
                                            <td className="px-6 py-4 w-1/3">
                                                <div className="w-full bg-gray-200 rounded-full h-2.5">
                                                    <div className="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style={{ width: `${percent}%` }}></div>
                                                </div>
                                                <div className="text-xs text-gray-500 mt-1">{percent.toFixed(0)}%</div>
                                            </td>
                                            <td className="px-6 py-4 font-mono text-gray-700">{stats.score.toFixed(2)}</td>
                                            <td className="px-6 py-4 font-mono text-gray-400 text-right">{tier.maxScore}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const TierView = ({ tierIndex, data, updateControl, showNotify, setView }) => {
            const tier = data[tierIndex];
            const stats = calculateTierScore(tier);
            
            return (
                <div className="max-w-4xl mx-auto pb-20">
                    {/* Header */}
                    <div className="flex items-end justify-between mb-6 border-b pb-4">
                        <div>
                            <h2 className="text-3xl font-bold text-gray-900">{tier.name}</h2>
                            <p className="text-gray-500">{tier.description}</p>
                        </div>
                        <div className="text-right">
                            <div className="text-2xl font-bold text-indigo-600">{stats.score} <span className="text-gray-400 text-lg">/ {tier.maxScore}</span></div>
                            <div className="text-sm text-gray-500">Current Score</div>
                        </div>
                    </div>

                    {/* Controls List */}
                    <div className="space-y-6">
                        {tier.controls.map((control, cIdx) => (
                            <ControlCard 
                                key={control.id}
                                control={control}
                                tierIndex={tierIndex}
                                cIdx={cIdx}
                                updateControl={updateControl}
                                showNotify={showNotify}
                            />
                        ))}
                    </div>

                    {/* Navigation Footer */}
                    <div className="flex justify-between mt-8">
                        <button 
                            onClick={() => setView(tierIndex > 0 ? `tier-${tierIndex - 1}` : 'intro')}
                            className="px-6 py-3 bg-white border rounded-lg hover:bg-gray-50 text-gray-700"
                        >
                            Previous
                        </button>
                        <button 
                            onClick={() => setView(tierIndex < 9 ? `tier-${tierIndex + 1}` : 'summary')}
                            className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md flex items-center gap-2"
                        >
                            {tierIndex < 9 ? 'Next Tier' : 'Finish & View Summary'} <ChevronRight className="w-4 h-4"/>
                        </button>
                    </div>
                </div>
            );
        };

        const SummaryView = ({ data, downloadData, sortConfig, setSortConfig, assessmentMeta }) => {
            const [showDownloadMenu, setShowDownloadMenu] = useState(false);
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setShowDownloadMenu(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const aggregates = useMemo(() => calculateAggregates(data), [data]);

            const handleReportDownload = (type) => {
                setShowDownloadMenu(false);
                if (type === 'json') {
                    downloadData();
                } else if (type === 'executive') {
                    generateExecutiveReport(data, assessmentMeta, aggregates);
                } else if (type === 'detailed') {
                    generateDetailedReport(data, assessmentMeta, aggregates);
                }
            };

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const sortedData = useMemo(() => {
                // Flatten the data structure for the table
                let flat = data.flatMap((tier) => 
                    tier.controls.map((c) => ({
                        ...c,
                        tierNum: tier.id, 
                        tierName: tier.name
                    }))
                );

                // Sort comparison function
                const compareIds = (a, b) => {
                    const partsA = a.toString().split('.').map(Number);
                    const partsB = b.toString().split('.').map(Number);
                    
                    for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
                        const valA = partsA[i] || 0;
                        const valB = partsB[i] || 0;
                        if (valA !== valB) return valA - valB;
                    }
                    return 0;
                };

                flat.sort((a, b) => {
                    let comparison = 0;
                    
                    // Primary Sorting
                    switch(sortConfig.key) {
                        case 'tier':
                            comparison = a.tierNum - b.tierNum;
                            break;
                        case 'id':
                            comparison = compareIds(a.id, b.id);
                            break;
                        case 'title':
                            comparison = a.title.localeCompare(b.title);
                            break;
                        case 'status':
                            // Sort by score value: null -> N/A -> 1 -> 2 -> 3 -> 4
                            const getLevelVal = (l) => {
                                if (l === 'N/A') return -1;
                                if (!l) return -2;
                                    return parseInt(l);
                            };
                            comparison = getLevelVal(a.selectedLevel) - getLevelVal(b.selectedLevel);
                            break;
                        case 'evidence':
                            // Sort by boolean: has notes or attachments
                            const hasEvA = (a.evidence?.notes || a.evidence?.attachments?.length) ? 1 : 0;
                            const hasEvB = (b.evidence?.notes || b.evidence?.attachments?.length) ? 1 : 0;
                            comparison = hasEvA - hasEvB;
                            break;
                        case 'points':
                            const getPoints = (l) => (l && l !== 'N/A' ? l * 0.25 : 0);
                            comparison = getPoints(a.selectedLevel) - getPoints(b.selectedLevel);
                            break;
                        default:
                            comparison = 0;
                    }

                    // Apply Sort Direction
                    if (sortConfig.direction === 'desc') {
                        comparison *= -1;
                    }

                    // Secondary Sort (Safeguard) - Always Ascending unless it is the primary key
                    if (comparison === 0 && sortConfig.key !== 'id') {
                        return compareIds(a.id, b.id);
                    }

                    return comparison;
                });

                return flat;
            }, [data, sortConfig]);

            const SortHeader = ({ label, sKey, align = "left" }) => {
                return (
                    <th 
                        className={`px-4 py-3 cursor-pointer hover:bg-gray-100 transition select-none ${align === 'right' ? 'text-right' : 'text-left'}`}
                        onClick={() => handleSort(sKey)}
                    >
                        <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : 'justify-start'}`}>
                            {label}
                            <span className="text-gray-400 flex flex-col items-center justify-center h-4 w-4">
                                {sortConfig.key === sKey ? (
                                    sortConfig.direction === 'asc' ? <ChevronUp className="w-3 h-3 text-indigo-600" /> : <ChevronDown className="w-3 h-3 text-indigo-600" />
                                ) : (
                                    <div className="flex flex-col opacity-30 group-hover:opacity-100">
                                        <ChevronUp className="w-2 h-2" />
                                        <ChevronDown className="w-2 h-2 -mt-1" />
                                    </div>
                                )}
                            </span>
                        </div>
                    </th>
                );
            };

            return (
                <div className="max-w-6xl mx-auto pb-10">
                    <div className="bg-white rounded-xl shadow-lg border overflow-visible relative">
                        <div className="p-6 border-b flex justify-between items-center bg-gray-50">
                            <h2 className="text-2xl font-bold text-gray-800">Complete Assessment Summary</h2>
                            
                            <div className="relative" ref={menuRef}>
                                <button 
                                    onClick={() => setShowDownloadMenu(!showDownloadMenu)}
                                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-sm"
                                >
                                    <Download className="w-4 h-4" /> Download Report <ChevronDown className="w-4 h-4" />
                                </button>
                                
                                {showDownloadMenu && (
                                    <div className="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-100 z-50 overflow-hidden animate-fade-in">
                                        <div className="p-2 space-y-1">
                                            <button 
                                                onClick={() => handleReportDownload('executive')}
                                                className="w-full text-left px-4 py-3 hover:bg-gray-50 rounded flex items-start gap-3 transition"
                                            >
                                                <div className="p-2 bg-purple-100 rounded text-purple-600"><LayoutDashboard className="w-4 h-4" /></div>
                                                <div>
                                                    <span className="block font-semibold text-gray-800 text-sm">Executive Report</span>
                                                    <span className="block text-xs text-gray-500">Charts, Scores & High-level stats. (PDF)</span>
                                                </div>
                                            </button>

                                            <button 
                                                onClick={() => handleReportDownload('detailed')}
                                                className="w-full text-left px-4 py-3 hover:bg-gray-50 rounded flex items-start gap-3 transition"
                                            >
                                                <div className="p-2 bg-blue-100 rounded text-blue-600"><ListChecks className="w-4 h-4" /></div>
                                                <div>
                                                    <span className="block font-semibold text-gray-800 text-sm">Detailed Report</span>
                                                    <span className="block text-xs text-gray-500">Full list of controls, evidence & notes. (PDF)</span>
                                                </div>
                                            </button>
                                            
                                            <div className="border-t my-1"></div>
                                            
                                            <button 
                                                onClick={() => handleReportDownload('json')}
                                                className="w-full text-left px-4 py-3 hover:bg-gray-50 rounded flex items-start gap-3 transition"
                                            >
                                                <div className="p-2 bg-gray-100 rounded text-gray-600"><FileJson className="w-4 h-4" /></div>
                                                <div>
                                                    <span className="block font-semibold text-gray-800 text-sm">Backup Data</span>
                                                    <span className="block text-xs text-gray-500">Save raw JSON for later restoration.</span>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 text-gray-500 font-medium border-b">
                                    <tr>
                                        <SortHeader label="Tier" sKey="tier" />
                                        <SortHeader label="Safeguard" sKey="id" />
                                        <SortHeader label="Control Title" sKey="title" />
                                        <SortHeader label="Status" sKey="status" />
                                        <SortHeader label="Evidence" sKey="evidence" />
                                        <SortHeader label="Points" sKey="points" align="right" />
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {sortedData.map((c) => (
                                        <tr key={`${c.tierNum}-${c.id}`} className="hover:bg-gray-50">
                                            <td className="px-4 py-3 font-medium text-gray-700">{c.tierName}</td>
                                            <td className="px-4 py-3 font-mono text-gray-500 font-bold">{c.id}</td>
                                            <td className="px-4 py-3 text-gray-800">{c.title}</td>
                                            <td className="px-4 py-3">
                                                {!c.selectedLevel ? <span className="text-gray-400 italic">Not Scored</span> :
                                                    c.selectedLevel === 'N/A' ? <span className="px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs font-bold">N/A</span> :
                                                    c.selectedLevel == 4 ? <span className="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold">Complete</span> :
                                                    c.selectedLevel == 3 ? <span className="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold">Majority</span> :
                                                    c.selectedLevel == 2 ? <span className="px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-xs font-bold">Partial</span> :
                                                    <span className="px-2 py-1 rounded bg-red-100 text-red-700 text-xs font-bold">Initial</span>}
                                            </td>
                                            <td className="px-4 py-3 text-gray-500">
                                                {c.evidence && c.evidence.notes && <MessageSquare className="w-4 h-4 inline-block mr-2" />}
                                                {c.evidence && c.evidence.attachments && c.evidence.attachments.length > 0 && <Paperclip className="w-4 h-4 inline-block" />}
                                            </td>
                                            <td className="px-4 py-3 text-right font-mono">
                                                {c.selectedLevel && c.selectedLevel !== 'N/A' ? (c.selectedLevel * 0.25).toFixed(2) : '-'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const AssessmentInfoView = ({ meta, updateMeta, assessmentTypes, selectedTypeID }) => {
            const handleEndAssessment = () => {
                updateMeta('endDate', new Date().toLocaleDateString());
            };

            // Calculate display name for the selected type
            const selectedTypeName = useMemo(() => {
                if (!selectedTypeID) return "None Selected";
                const type = assessmentTypes.find(t => t.TypeID == selectedTypeID);
                return type ? type.Type : "Unknown Type";
            }, [selectedTypeID, assessmentTypes]);

            // Basic helper to encode address for google maps embed iframe
            const mapSrc = meta.address 
                ? `https://maps.google.com/maps?q=${encodeURIComponent(meta.address)}&t=&z=13&ie=UTF8&iwloc=&output=embed`
                : "";

            return (
                <div className="max-w-4xl mx-auto space-y-6">
                    <div className="bg-white p-8 rounded-xl shadow-sm border">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                            <Building className="w-6 h-6 text-indigo-600" /> Assessment Information
                        </h2>
                        
                        {/* New Label for Selected Type */}
                        <div className="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-6">
                            <div className="flex items-center">
                                <div className="flex-shrink-0">
                                    <ListChecks className="h-5 w-5 text-indigo-400" />
                                </div>
                                <div className="ml-3">
                                    <p className="text-sm text-indigo-700">
                                        Selected Assessment Type: <span className="font-bold">{selectedTypeName}</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div className="col-span-2">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Organization Name</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
                                    value={meta.orgName}
                                    onChange={(e) => updateMeta('orgName', e.target.value)}
                                    placeholder="Enter Organization Name..."
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Assessment Start Date</label>
                                <div className="w-full p-2 bg-gray-100 border rounded-md text-gray-700 flex items-center gap-2">
                                    <Calendar className="w-4 h-4 text-gray-500" />
                                    {meta.startDate}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Assessment End Date</label>
                                <div className="flex gap-2">
                                    <div className="flex-1 p-2 bg-gray-100 border rounded-md text-gray-700 flex items-center gap-2 min-h-[42px]">
                                        <Calendar className="w-4 h-4 text-gray-500" />
                                        {meta.endDate || "Not Ended"}
                                    </div>
                                    <button 
                                        onClick={handleEndAssessment}
                                        className="px-4 py-2 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 transition whitespace-nowrap"
                                    >
                                        End Assessment
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="border-t pt-6 mb-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <MapPin className="w-5 h-5 text-gray-500" /> Organization Details
                            </h3>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Physical Address</label>
                                    <textarea 
                                        className="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none mb-4"
                                        rows="3"
                                        value={meta.address}
                                        onChange={(e) => updateMeta('address', e.target.value)}
                                        placeholder="1234 Main St, City, State, Zip"
                                    ></textarea>
                                    
                                    {meta.address && (
                                        <div className="w-full h-48 bg-gray-100 rounded-lg overflow-hidden border">
                                            <iframe 
                                                width="100%" 
                                                height="100%" 
                                                src={mapSrc} 
                                                frameBorder="0" 
                                                scrolling="no" 
                                                marginHeight="0" 
                                                marginWidth="0"
                                            ></iframe>
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Authorizing Individual (CIO/CISO)</label>
                                        <input 
                                            type="text" placeholder="Name" 
                                            className="w-full p-2 border rounded-md mb-2 text-sm"
                                            value={meta.authorizer.name}
                                            onChange={(e) => updateMeta('authorizer', { ...meta.authorizer, name: e.target.value })}
                                        />
                                        <div className="grid grid-cols-2 gap-2">
                                            <input 
                                                type="text" placeholder="Phone" 
                                                className="w-full p-2 border rounded-md text-sm"
                                                value={meta.authorizer.phone}
                                                onChange={(e) => updateMeta('authorizer', { ...meta.authorizer, phone: e.target.value })}
                                            />
                                            <input 
                                                type="text" placeholder="Email" 
                                                className="w-full p-2 border rounded-md text-sm"
                                                value={meta.authorizer.email}
                                                onChange={(e) => updateMeta('authorizer', { ...meta.authorizer, email: e.target.value })}
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Primary Point of Contact</label>
                                        <input 
                                            type="text" placeholder="Name" 
                                            className="w-full p-2 border rounded-md mb-2 text-sm"
                                            value={meta.poc.name}
                                            onChange={(e) => updateMeta('poc', { ...meta.poc, name: e.target.value })}
                                        />
                                        <div className="grid grid-cols-2 gap-2">
                                            <input 
                                                type="text" placeholder="Phone" 
                                                className="w-full p-2 border rounded-md text-sm"
                                                value={meta.poc.phone}
                                                onChange={(e) => updateMeta('poc', { ...meta.poc, phone: e.target.value })}
                                            />
                                            <input 
                                                type="text" placeholder="Email" 
                                                className="w-full p-2 border rounded-md text-sm"
                                                value={meta.poc.email}
                                                onChange={(e) => updateMeta('poc', { ...meta.poc, email: e.target.value })}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="mt-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Company Notes</label>
                                <textarea 
                                    className="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
                                    rows="2"
                                    value={meta.orgNotes}
                                    onChange={(e) => updateMeta('orgNotes', e.target.value)}
                                    placeholder="Brief description or notes about the company..."
                                ></textarea>
                            </div>
                        </div>

                        <div className="border-t pt-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <User className="w-5 h-5 text-gray-500" /> Assessor Details
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Assessor Name</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.name}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, name: e.target.value })}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Assessor Company</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.company}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, company: e.target.value })}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.phone || ""}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, phone: e.target.value })}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.email || ""}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, email: e.target.value })}
                                    />
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Website</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded-md"
                                        value={meta.assessor.website || ""}
                                        onChange={(e) => updateMeta('assessor', { ...meta.assessor, website: e.target.value })}
                                        placeholder="https://"
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Assessment Notes</label>
                                <textarea 
                                    className="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
                                    rows="4"
                                    value={meta.assessmentNotes}
                                    onChange={(e) => updateMeta('assessmentNotes', e.target.value)}
                                    placeholder="General notes regarding the assessment execution..."
                                ></textarea>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const App = () => {
            const [view, setView] = useState('intro'); 
            const [data, setData] = useState(INITIAL_DATA);
            const [notification, setNotification] = useState(null);
            const [loading, setLoading] = useState(false);
            const [assessmentTypes, setAssessmentTypes] = useState([]);
            const [selectedTypeID, setSelectedTypeID] = useState(""); // Stores the numeric TypeID
            const [isMapLoaded, setIsMapLoaded] = useState(false);
            // Lifted state for sorting configuration
            const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'asc' });

            // New State for Assessment Meta Information
            const [assessmentMeta, setAssessmentMeta] = useState({
                orgName: "",
                startDate: new Date().toLocaleDateString(),
                endDate: "",
                address: "",
                authorizer: { name: "", phone: "", email: "" },
                poc: { name: "", phone: "", email: "" },
                orgNotes: "",
                assessor: { name: "", company: "", phone: "", email: "", website: "" },
                assessmentNotes: ""
            });

            // Reusable function to fetch and apply rubrics
            const fetchAndApplyRubrics = async (targetTypeID, currentData) => {
                try {
                    setLoading(true);
                    const res = await fetch(RUBRIC_URL);
                    const rubrics = await res.json();
                    
                    const dataToUpdate = currentData || data;

                    // Update rubrics in data based on target type
                    const updatedData = dataToUpdate.map(tier => ({
                        ...tier,
                        controls: tier.controls.map(control => {
                            // Normalize IDs for comparison
                            const controlId = (control.id || "").toString().replace(/^SG/i, '');
                            
                            // Find all rubric entries for this specific control
                            const allRubricEntriesForControl = rubrics.filter(r => {
                                const rSafeguardID = (r.SafeguardID || "").toString().replace(/^SG/i, '');
                                return rSafeguardID === controlId;
                            });

                            if (allRubricEntriesForControl.length > 0) {
                                const newLevels = { ...control.levels };
                                
                                // Iterate through levels 1-4
                                [1, 2, 3, 4].forEach(level => {
                                    // 1. Try to find entry for the TARGET Type ID
                                    const targetEntry = allRubricEntriesForControl.find(r => 
                                        r.TypeID.toString() === targetTypeID.toString() && 
                                        r.Level.toString().includes(level.toString())
                                    );

                                    // 2. Try to find entry for the DEFAULT Type ID (1)
                                    const defaultEntry = allRubricEntriesForControl.find(r => 
                                        r.TypeID.toString() === "1" && 
                                        r.Level.toString().includes(level.toString())
                                    );

                                    // Apply Logic: Use Target if exists, otherwise fallback to Default (ID=1)
                                    if (targetEntry) {
                                        newLevels[level] = targetEntry.Description;
                                    } else if (defaultEntry) {
                                        newLevels[level] = defaultEntry.Description;
                                    }
                                    // If neither exists, keep existing value (likely placeholder)
                                });

                                return {
                                    ...control,
                                    levels: newLevels
                                };
                            }
                            return control;
                        })
                    }));
                    
                    setData(updatedData);
                    return true;
                } catch (err) {
                    console.error("Failed to load rubrics", err);
                    showNotify("Failed to load rubrics", true);
                    return false;
                } finally {
                    setLoading(false);
                }
            };

            // Load from LocalStorage on Mount
            useEffect(() => {
                const savedData = localStorage.getItem('cis_assessment_data');
                
                // Fetch assessment types regardless of storage
                fetch(ASSESSMENT_TYPES_URL)
                    .then(res => res.json())
                    .then(types => {
                        if (Array.isArray(types)) setAssessmentTypes(types);
                        else if (types.types) setAssessmentTypes(types.types);
                    })
                    .catch(err => console.error("Failed to load assessment types", err));

                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        
                        // Load Control Data
                        let controlsData = parsed;
                        // Handle new format where data is nested
                        if (!Array.isArray(parsed) && parsed.data) {
                            controlsData = parsed.data;
                        }

                        if(controlsData && Array.isArray(controlsData) && controlsData.length === 10) {
                            const normalized = controlsData.map(tier => ({
                                ...tier,
                                controls: tier.controls.map(c => ({
                                    ...c,
                                    evidence: c.evidence || { notes: "", attachments: [] }
                                }))
                            }));
                            setData(normalized);
                            setIsMapLoaded(true);
                        }

                        // Load Assessment Meta if it exists
                        if (parsed.assessmentMeta) {
                            setAssessmentMeta(parsed.assessmentMeta);
                        }

                        // Load Type ID
                        if (parsed.assessmentTypeID) {
                            setSelectedTypeID(parsed.assessmentTypeID);
                        }

                        // Load Sort Config
                        if (parsed.sortConfig) {
                            setSortConfig(parsed.sortConfig);
                        }

                    } catch (e) {
                        console.error("Error loading data", e);
                    }
                } else {
                    // **NEW LOGIC: Initial Load without user selection**
                    // If no saved data, fetch and apply Type ID = 1 rubrics by default
                    // But keep selectedTypeID empty so UI shows "Select Type..."
                    fetchAndApplyRubrics(1, INITIAL_DATA).then(() => {
                        setIsMapLoaded(true); // Enable Tiers even if just default loaded
                    });
                }
                
            }, []);

            // Save to LocalStorage on Change
            useEffect(() => {
                try {
                    const storageObj = {
                        data: data,
                        assessmentMeta: assessmentMeta,
                        assessmentTypeID: selectedTypeID,
                        sortConfig: sortConfig
                    };
                    localStorage.setItem('cis_assessment_data', JSON.stringify(storageObj));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        showNotify("Storage Quota Exceeded! Remove some large attachments.", true);
                    }
                }
            }, [data, assessmentMeta, selectedTypeID, sortConfig]);

            const updateAssessmentMeta = (field, value) => {
                setAssessmentMeta(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const handleTypeChange = async (e) => {
                const newTypeID = e.target.value;
                setSelectedTypeID(newTypeID);

                if (!newTypeID) return;

                // Reuse the new function to apply rubrics
                const success = await fetchAndApplyRubrics(newTypeID, data);
                if (success) {
                    showNotify(`Rubrics loaded for Assessment Type ID: ${newTypeID}`);
                }
            };

            const updateControl = (tierIndex, controlIndex, updates) => {
                const newData = [...data];
                newData[tierIndex].controls[controlIndex] = {
                    ...newData[tierIndex].controls[controlIndex],
                    ...updates
                };
                setData(newData);
            };

            const downloadData = () => {
                const exportObj = {
                    assessmentTypeID: selectedTypeID,
                    timestamp: new Date().toISOString(),
                    assessmentMeta: assessmentMeta,
                    data: data,
                    sortConfig: sortConfig
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `cis_assessment_backup.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                showNotify("Backup JSON file saved!");
            };

            const handleFileUpload = (event) => {
                const fileReader = new FileReader();
                fileReader.readAsText(event.target.files[0], "UTF-8");
                fileReader.onload = e => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        // Handle both old array format and new object format
                        let controlsData = Array.isArray(parsed) ? parsed : parsed.data;
                        
                        if (controlsData && controlsData.length > 0 && controlsData[0].controls) {
                            const normalized = controlsData.map(tier => ({
                                ...tier,
                                controls: tier.controls.map(c => ({
                                    ...c,
                                    evidence: c.evidence || { notes: "", attachments: [] }
                                }))
                            }));
                            setData(normalized);
                            if (parsed.assessmentTypeID) setSelectedTypeID(parsed.assessmentTypeID);
                            if (parsed.assessmentMeta) setAssessmentMeta(parsed.assessmentMeta);
                            if (parsed.sortConfig) setSortConfig(parsed.sortConfig);
                            
                            setIsMapLoaded(true);
                            showNotify("Assessment loaded successfully!");
                        } else {
                            showNotify("Invalid assessment backup file.", true);
                        }
                    } catch (err) {
                        showNotify("Error parsing file.", true);
                    }
                };
            };

            const processMappingData = (jsonInput) => {
                let items = [];
                if (Array.isArray(jsonInput)) {
                    items = jsonInput;
                } else if (jsonInput && typeof jsonInput === 'object') {
                    const key = Object.keys(jsonInput).find(k => Array.isArray(jsonInput[k]));
                    if (key) items = jsonInput[key];
                }

                if (!items.length) {
                    showNotify("JSON valid, but no array of controls found.", true);
                    return;
                }

                const newStructure = INITIAL_DATA.map(t => ({...t, controls: []}));
                let matchCount = 0;
                
                items.forEach(item => {
                    const getVal = (k) => item[Object.keys(item).find(key => key.toLowerCase() === k.toLowerCase())];
                    
                    let tierNum = getVal('TierNumber');
                    if (!tierNum) tierNum = getVal('tier');
                    
                    let rawId = getVal('ID'); 
                    if (!rawId) rawId = getVal('safeguard');

                    let title = getVal('Title') || getVal('name');
                    let description = getVal('Description') || getVal('desc') || getVal('Action Plan');
                    
                    if (tierNum && rawId) {
                        const tierInt = parseInt(tierNum);
                        const cleanId = rawId.toString().replace(/^SG/i, '');

                        if (!isNaN(tierInt) && tierInt >= 1 && tierInt <= 10) {
                            newStructure[tierInt - 1].controls.push({
                                id: cleanId,
                                title: title || "Title Unavailable",
                                actionPlan: description || "Description Unavailable",
                                levels: { 1: "Initial", 2: "Partial", 3: "Majority", 4: "Complete" },
                                selectedLevel: null,
                                evidence: { notes: "", attachments: [] }
                            });
                            matchCount++;
                        }
                    }
                });

                const totalControls = newStructure.reduce((acc, t) => acc + t.controls.length, 0);
                
                if (totalControls > 0) {
                    newStructure.forEach(t => {
                        t.controls.sort((a, b) => {
                            if (!a.id || !b.id) return 0;
                            const aParts = a.id.toString().split('.').map(Number);
                            const bParts = b.id.toString().split('.').map(Number);
                            if(aParts[0] !== bParts[0]) return aParts[0] - bParts[0];
                            return aParts[1] - bParts[1];
                        });
                    });
                    setData(newStructure);
                    setIsMapLoaded(true);
                    showNotify(`Successfully populated ${totalControls} controls!`);
                } else {
                    showNotify("No valid controls found (TierNumber 1-10 missing in JSON).", true);
                }
            };

            const handleUrlFetch = async () => {
                setLoading(true);
                try {
                    const response = await fetch(MAP_URL);
                    if (!response.ok) throw new Error("Network response was not ok");
                    const jsonMap = await response.json();
                    processMappingData(jsonMap);
                } catch (error) {
                    console.error("Fetch error:", error);
                    showNotify("Failed to fetch from GitHub. Please check network/URL.", true);
                } finally {
                    setLoading(false);
                }
            };

            const handleMappingUpload = (event) => {
                const fileReader = new FileReader();
                fileReader.readAsText(event.target.files[0], "UTF-8");
                fileReader.onload = e => {
                    try {
                        const jsonMap = JSON.parse(e.target.result);
                        processMappingData(jsonMap);
                    } catch (err) {
                        showNotify("Error parsing mapping file.", true);
                    }
                };
            };

            const showNotify = (msg, isError = false) => {
                setNotification({ msg, isError });
                setTimeout(() => setNotification(null), 3000);
            };

            // Calculate Aggregates
            const aggregates = useMemo(() => {
                return calculateAggregates(data);
            }, [data]);

            // --- Main Render Switch ---
            const renderContent = () => {
                if (view === 'intro') return <IntroductionView setView={setView} />;
                if (view === 'info') return <AssessmentInfoView meta={assessmentMeta} updateMeta={updateAssessmentMeta} assessmentTypes={assessmentTypes} selectedTypeID={selectedTypeID} />;
                if (view === 'score') return <ScoreView aggregates={aggregates} data={data} setView={setView} />;
                if (view === 'summary') return <SummaryView data={data} downloadData={downloadData} sortConfig={sortConfig} setSortConfig={setSortConfig} assessmentMeta={assessmentMeta} />;
                if (view === 'about') return <AboutView />;
                if (view.startsWith('tier-')) return <TierView tierIndex={parseInt(view.split('-')[1])} data={data} updateControl={updateControl} showNotify={showNotify} setView={setView} />;
                return <IntroductionView setView={setView} />;
            };

            return (
                <div className="flex min-h-screen">
                    <Sidebar 
                        view={view} 
                        setView={setView} 
                        loading={loading}
                        handleUrlFetch={handleUrlFetch}
                        selectedTypeID={selectedTypeID}
                        handleTypeChange={handleTypeChange}
                        isMapLoaded={isMapLoaded}
                        assessmentTypes={assessmentTypes}
                        data={data}
                        downloadData={downloadData}
                        handleMappingUpload={handleMappingUpload}
                        handleFileUpload={handleFileUpload}
                    />
                    <main className="flex-1 ml-64 p-8 overflow-y-auto h-screen">
                        {renderContent()}
                    </main>
                    
                    {notification && (
                        <div className={`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium animate-bounce ${notification.isError ? 'bg-red-600' : 'bg-green-600'}`}>
                            {notification.msg}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>